<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Niaz OS - Portfolio</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet">

    <style>
        :root {
            font-size: 16px;
            /* Theme Variables */
            --bg-primary: #111;
            --bg-secondary: #202020;
            --bg-tertiary: #2b2b2b;
            --text-primary: #ffffff;
            --text-secondary: #d1d5db;
            --accent-color: #60cdff;
            --border-color: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(32, 32, 32, 0.75);
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #f0f0f0;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f5f5f5;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --accent-color: #3b82f6;
            --border-color: rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.75);
        }
        
        /* Dark Blue Theme */
        [data-theme="blue"] {
            --bg-primary: #0a0e27;
            --bg-secondary: #1a1f3a;
            --bg-tertiary: #252b48;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-color: #60a5fa;
            --border-color: rgba(96, 165, 250, 0.2);
            --glass-bg: rgba(26, 31, 58, 0.75);
        }
        
        /* Purple Theme */
        [data-theme="purple"] {
            --bg-primary: #1a0d2e;
            --bg-secondary: #2d1b4e;
            --bg-tertiary: #3e2b5f;
            --text-primary: #f3e8ff;
            --text-secondary: #c4b5fd;
            --accent-color: #a855f7;
            --border-color: rgba(168, 85, 247, 0.2);
            --glass-bg: rgba(45, 27, 78, 0.75);
        }
        
        /* Green Theme */
        [data-theme="green"] {
            --bg-primary: #0a2e0a;
            --bg-secondary: #1a4d1a;
            --bg-tertiary: #2d5f2d;
            --text-primary: #dcfce7;
            --text-secondary: #86efac;
            --accent-color: #22c55e;
            --border-color: rgba(34, 197, 94, 0.2);
            --glass-bg: rgba(26, 77, 26, 0.75);
        }

        body {
            font-family: 'Noto Sans', sans-serif;
            overflow: hidden;
            user-select: none;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 0.5rem;
            height: 0.5rem;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 0.25rem;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* UI Root */
        #ui-root {
            background-image: url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop'); 
            background-size: cover;
            background-position: center;
            transition: width 0.3s, height 0.3s, transform 0.3s, border-radius 0.3s;
            position: relative;
            margin: 0 auto; 
            box-shadow: 0 0 0 0 rgba(0,0,0,0);
        }

        /* Glassmorphism */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-color);
        }
        
        .glass-light {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }
        
        .context-menu {
            background: rgba(45, 45, 45, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        /* Window Animations */
        .window-transition {
            transition: transform 0.15s cubic-bezier(0.2, 0, 0, 1), opacity 0.15s, width 0.2s, height 0.2s, top 0.2s, left 0.2s, box-shadow 0.3s;
        }
        
        /* Dynamic Window Shadows */
        .window-shadow-low {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .window-shadow-high {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.1);
        }
        
        /* Window Blur Effect */
        .window-inactive {
            opacity: 0.85;
            filter: brightness(0.8);
        }
        
        .window-active {
            opacity: 1;
            filter: brightness(1);
        }

        @keyframes windowFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes minimizeToTaskbar {
            to {
                transform: scale(0) translateY(100vh);
                opacity: 0;
            }
        }
        
        @keyframes restoreFromTaskbar {
            from {
                transform: scale(0) translateY(100vh);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes ripple {
            from {
                transform: scale(0);
                opacity: 1;
            }
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        .window-fade-in {
            animation: windowFadeIn 0.3s ease-out;
        }
        
        .minimize-animation {
            animation: minimizeToTaskbar 0.3s ease-in forwards;
        }
        
        .restore-animation {
            animation: restoreFromTaskbar 0.3s ease-out;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeOut 0.5s ease-out 1.5s forwards;
        }
        
        @keyframes fadeOut {
            to {
                opacity: 0;
                pointer-events: none;
            }
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top-color: #60cdff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Animated Wallpapers */
        #animated-bg {
            position: absolute;
            inset: 0;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        #animated-bg.active {
            opacity: 1;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .animated-gradient {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        .animated-gradient-blue {
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #4facfe);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        .animated-gradient-purple {
            background: linear-gradient(-45deg, #a8edea, #fed6e3, #d299c2, #fef9d7);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        /* Custom Cursors */
        body {
            cursor: default;
        }
        
        button, .cursor-pointer {
            cursor: pointer !important;
        }
        
        .resize-handle-n, .resize-handle-s {
            cursor: ns-resize !important;
        }
        
        .resize-handle-e, .resize-handle-w {
            cursor: ew-resize !important;
        }
        
        .resize-handle-ne, .resize-handle-sw {
            cursor: nesw-resize !important;
        }
        
        .resize-handle-nw, .resize-handle-se {
            cursor: nwse-resize !important;
        }
        
        .window-transition:active {
            cursor: grabbing !important;
        }
        
        input[type="text"], textarea, [contenteditable="true"] {
            cursor: text !important;
        }
        
        a, .link {
            cursor: pointer !important;
        }
        
        .loading, .loading * {
            cursor: wait !important;
        }
        
        .disabled, [disabled] {
            cursor: not-allowed !important;
        }

        .taskbar-item-active::after {
            content: '';
            position: absolute;
            bottom: 0;
            width: 6px;
            height: 3px;
            background: #60cdff;
            border-radius: 2px;
            transition: width 0.2s;
        }
        
        .taskbar-item-active:hover::after {
            width: 16px;
        }

        /* Start Menu Animation */
        #start-menu {
            transition: bottom 0.3s cubic-bezier(0.1, 0.9, 0.2, 1), opacity 0.2s;
        }

        /* Cursor Blink */
        .cursor-blink {
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Window Resize Handles */
        .resize-handle {
            position: absolute;
            z-index: 10;
        }
        .resize-handle-n {
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            cursor: ns-resize;
        }
        .resize-handle-s {
            bottom: 0;
            left: 0;
            right: 0;
            height: 5px;
            cursor: ns-resize;
        }
        .resize-handle-e {
            top: 0;
            right: 0;
            bottom: 0;
            width: 5px;
            cursor: ew-resize;
        }
        .resize-handle-w {
            top: 0;
            left: 0;
            bottom: 0;
            width: 5px;
            cursor: ew-resize;
        }
        .resize-handle-ne {
            top: 0;
            right: 0;
            width: 10px;
            height: 10px;
            cursor: nesw-resize;
        }
        .resize-handle-nw {
            top: 0;
            left: 0;
            width: 10px;
            height: 10px;
            cursor: nwse-resize;
        }
        .resize-handle-se {
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            cursor: nwse-resize;
        }
        .resize-handle-sw {
            bottom: 0;
            left: 0;
            width: 10px;
            height: 10px;
            cursor: nesw-resize;
        }

        /* Resume Formatting */
        .resume-page {
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            transform-origin: top center;
            transition: transform 0.2s ease-out;
        }

        /* Submenu Logic */
        .menu-item:hover .submenu {
            display: flex;
        }
        
        /* Brightness Overlay */
        #brightness-overlay {
            pointer-events: none;
            z-index: 99999;
            background: black;
            opacity: 0;
            transition: opacity 0.1s;
        }

        /* Game Font */
        .font-game {
            font-family: 'Press Start 2P', monospace;
        }

        /* Taskbar Preview */
        .taskbar-preview {
            position: absolute;
            bottom: 3.5rem;
            background: rgba(32, 32, 32, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
        }
        
        .taskbar-preview.show {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center bg-black overflow-hidden">

    <div id="brightness-overlay" class="fixed inset-0 w-full h-full"></div>

    <div id="ui-root" class="w-full h-full overflow-hidden text-white relative text-base">
        
        <!-- Animated Background Layer -->
        <div id="animated-bg" style="position: absolute; inset: 0; z-index: -1;"></div>
        <canvas id="particle-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0; transition: opacity 0.5s;"></canvas>
        
        <!-- Desktop Icons Container -->
        <div class="absolute top-0 left-0 h-full w-full p-2 grid grid-flow-col grid-rows-[repeat(auto-fill,6.25rem)] gap-2 content-start items-start w-fit z-0" id="desktop-icons">
            <!-- Icons injected by JS -->
        </div>

        <!-- Context Menu -->
        <div id="context-menu" class="context-menu fixed w-64 rounded-lg z-[9999] hidden flex-col py-1 text-sm text-gray-200">
            <div class="menu-item relative px-4 py-2 hover:bg-white/10 cursor-default flex items-center justify-between group">
                <div class="flex items-center gap-3"><i class="fa-solid fa-arrow-down-a-z w-4"></i> Sort by</div>
                <i class="fa-solid fa-chevron-right text-[10px]"></i>
                <div class="submenu hidden flex-col absolute left-full top-0 w-48 bg-[#2d2d2d] rounded-lg border border-white/10 shadow-xl py-1 ml-1">
                    <div class="px-4 py-2 hover:bg-white/10 cursor-pointer" onclick="sys.sortDesktop('name')">Name</div>
                    <div class="px-4 py-2 hover:bg-white/10 cursor-pointer" onclick="sys.sortDesktop('size')">Size</div>
                    <div class="px-4 py-2 hover:bg-white/10 cursor-pointer" onclick="sys.sortDesktop('type')">Item type</div>
                    <div class="px-4 py-2 hover:bg-white/10 cursor-pointer" onclick="sys.sortDesktop('date')">Date modified</div>
                </div>
            </div>
            <div class="px-4 py-2 hover:bg-white/10 cursor-default flex items-center gap-3" onclick="sys.renderDesktop(true)">
                <i class="fa-solid fa-rotate-right w-4"></i> Refresh
            </div>
            <div class="h-px bg-white/10 my-1"></div>
            <div class="px-4 py-2 hover:bg-white/10 cursor-default flex items-center gap-3" onclick="wm.openWindow('settings', {tab: 'system'})">
                <i class="fa-solid fa-desktop w-4"></i> Display settings
            </div>
            <div class="px-4 py-2 hover:bg-white/10 cursor-default flex items-center gap-3" onclick="wm.openWindow('settings', {tab: 'personalization'})">
                <i class="fa-solid fa-paintbrush w-4"></i> Personalize
            </div>
            <div class="h-px bg-white/10 my-1"></div>
            <div class="px-4 py-2 hover:bg-white/10 cursor-default flex items-center gap-3" onclick="wm.openWindow('terminal')">
                <i class="fa-brands fa-windows w-4"></i> Open in Terminal
            </div>
        </div>

        <!-- Windows Container -->
        <div id="window-area" class="absolute top-0 left-0 w-full h-full z-[40] pointer-events-none">
            <!-- Windows injected by JS -->
        </div>

        <!-- Start Menu -->
        <div id="start-menu" class="glass fixed bottom-[-40.625rem] left-1/2 transform -translate-x-1/2 w-[37.5rem] h-[40.625rem] rounded-t-xl z-[50] flex flex-col opacity-0 shadow-2xl border-b-0 duration-300">
            <div class="p-6 pb-2">
                <div class="bg-[#202020] border border-gray-700 rounded-md flex items-center px-3 py-2 shadow-inner">
                    <i class="fa-solid fa-magnifying-glass text-gray-400 mr-3"></i>
                    <input type="text" placeholder="Search apps, settings, and documents" class="bg-transparent border-none outline-none text-sm w-full text-white placeholder-gray-400">
                </div>
            </div>
            <div class="flex-1 p-6 pt-2 overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <span class="font-semibold text-sm">Pinned</span>
                    <button class="bg-white/10 px-2 py-0.5 rounded text-xs hover:bg-white/20 transition">All apps &gt;</button>
                </div>
                <div class="grid grid-cols-6 gap-4" id="start-menu-grid"></div>
            </div>
            <div class="h-16 glass-light rounded-b-xl border-t border-white/5 flex items-center justify-between px-8">
                <div class="flex items-center gap-3 hover:bg-white/5 p-2 rounded-md cursor-pointer transition">
                    <div class="w-8 h-8 rounded-full bg-gray-600 border border-gray-400 overflow-hidden">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Niaz" alt="Niaz" class="w-full h-full object-cover">
                    </div>
                    <span class="text-sm font-medium">Niaz</span>
                </div>
                <div class="hover:bg-white/5 p-2 rounded-md cursor-pointer transition" onclick="alert('Shutting down simulation...')">
                    <i class="fa-solid fa-power-off"></i>
                </div>
            </div>
        </div>

        <!-- Taskbar -->
        <div class="absolute bottom-0 w-full h-12 glass flex justify-between items-center px-4 z-[45] select-none" id="taskbar">
            <div class="w-32 hidden md:flex opacity-0 hover:opacity-100 transition duration-500">
                <div class="text-xs flex flex-col justify-center items-center cursor-pointer hover:bg-white/5 p-1 rounded">
                    <span id="weather-temp">21°C</span>
                    <span class="text-blue-300">Cloudy</span>
                </div>
            </div>
            <div class="flex items-center gap-1 h-full" id="taskbar-apps">
                <button id="start-btn" class="w-10 h-10 rounded hover:bg-white/10 flex items-center justify-center transition active:scale-95" onclick="sys.toggleStartMenu()">
                    <i class="fa-brands fa-windows text-blue-400 text-xl"></i>
                </button>
            </div>
            <div class="flex items-center gap-2 h-full">
                <div class="flex items-center gap-2 hover:bg-white/10 px-2 py-1 rounded transition cursor-pointer">
                    <i class="fa-solid fa-angle-up text-xs"></i>
                </div>
                <div class="flex items-center gap-3 hover:bg-white/10 px-2 py-1 rounded transition cursor-pointer">
                    <i class="fa-solid fa-wifi text-xs"></i>
                    <i class="fa-solid fa-volume-high text-xs"></i>
                    <i class="fa-solid fa-battery-full text-xs"></i>
                </div>
                <div class="text-right hover:bg-white/10 px-2 py-1 rounded transition cursor-pointer flex flex-col justify-center h-full" id="clock">
                    <div class="text-xs font-medium" id="clock-time">12:00 PM</div>
                    <div class="text-[10px]" id="clock-date">11/20/2025</div>
                </div>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const RESUME_CONTENT = `
            <div id="resume-container" class="resume-page bg-white text-black p-10 md:p-12 mx-auto max-w-[53rem] min-h-[68rem] font-sans selection:bg-blue-200 origin-top">
                <!-- Header -->
                <div class="flex justify-between items-start border-b-2 border-gray-800 pb-4 mb-6">
                    <div>
                        <h1 class="text-4xl font-bold text-gray-900 tracking-tight">Mohammed Niaz Ul Haque</h1>
                        <h2 class="text-xl font-semibold text-gray-700 mt-1">Full Stack Engineer @ Fourth Dimension (4D)</h2>
                        <p class="text-sm text-gray-600 mt-1"><i class="fa-solid fa-location-dot mr-1"></i> Scarborough, Ontario, Canada</p>
                    </div>
                    <div class="text-right text-sm text-gray-700 space-y-1">
                        <p><i class="fa-solid fa-phone mr-2"></i>647-657-6450</p>
                        <p><i class="fa-solid fa-envelope mr-2"></i>theniaz619@gmail.com</p>
                        <p><i class="fa-brands fa-linkedin mr-2"></i>linkedin.com/in/mohammed-niaz-ul</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-8">
                    <!-- Main Column -->
                    <div class="col-span-2">
                        <!-- Summary -->
                        <div class="mb-6">
                            <h3 class="text-sm font-bold text-blue-800 uppercase tracking-wider border-b border-gray-300 mb-2">Summary</h3>
                            <p class="text-sm leading-relaxed text-gray-800 text-justify">
                                Full Stack Engineer building secure, high-performing web platforms end to end. I lead development across a 30+ app portfolio at Fourth Dimension (4D), owning architecture, delivery, and maintenance—from serverless APIs on AWS (API Gateway, Lambda, CloudFront, DocumentDB) to React/Next.js and Angular frontends. I mentor an offshore team, enforce code quality, and drive security by design.
                            </p>
                        </div>

                        <!-- Experience -->
                        <div class="mb-6">
                            <h3 class="text-sm font-bold text-blue-800 uppercase tracking-wider border-b border-gray-300 mb-4">Experience</h3>
                            
                            <!-- Job 1 -->
                            <div class="mb-5">
                                <div class="flex justify-between items-baseline mb-1">
                                    <h4 class="font-bold text-gray-900 text-md">Fourth Dimension (4D)</h4>
                                    <span class="text-xs text-gray-600 font-mono">Oct 2023 - Present</span>
                                </div>
                                <p class="text-xs font-semibold text-gray-700 mb-2">Full Stack Engineer (Tech Lead) | Toronto, Canada</p>
                                <ul class="list-disc ml-4 text-sm text-gray-700 space-y-1 leading-snug">
                                    <li><strong>Leadership:</strong> Tech lead across 30+ app portfolio. Manage/mentor offshore teams on code reviews & architecture.</li>
                                    <li><strong>Full-Stack:</strong> Build RESTful APIs (Node.js, AWS Lambda); deliver frontends in React, Next.js, Angular.</li>
                                    <li><strong>Security:</strong> Lead security architecture; flagship app achieved a <strong>perfect penetration test score</strong>.</li>
                                    <li><strong>Accomplishments:</strong> Architected/launched a greenfield, multi-tenant, event-driven plugin platform. Leading legacy modernization (Angular &rarr; React, Azure &rarr; AWS).</li>
                                </ul>
                            </div>

                            <!-- Job 2 -->
                            <div class="mb-5">
                                <div class="flex justify-between items-baseline mb-1">
                                    <h4 class="font-bold text-gray-900 text-md">Merlin Solutions</h4>
                                    <span class="text-xs text-gray-600 font-mono">Nov 2022 - Sep 2023</span>
                                </div>
                                <p class="text-xs font-semibold text-gray-700 mb-2">Full Stack Developer | Ontario, Canada</p>
                                <ul class="list-disc ml-4 text-sm text-gray-700 space-y-1 leading-snug">
                                    <li>Deployed OAuth2 protocol for Union Bank accounts; integrated SMS authentication.</li>
                                    <li><strong>MerlinPay:</strong> Built comprehensive B2B/B2C payment platform using Vue.js.</li>
                                    <li><strong>CaRS:</strong> Developed universal Genmega Kiosk app dashboards (Vue.js) & cross-platform POS (Flutter).</li>
                                    <li>Optimized Kiosk hardware connections using .NET/C# WebSocket server (80% faster) and Java HTTP server.</li>
                                </ul>
                            </div>

                            <!-- Job 3 -->
                            <div class="mb-5">
                                <div class="flex justify-between items-baseline mb-1">
                                    <h4 class="font-bold text-gray-900 text-md">Ontario Treasury Board Secretariat</h4>
                                    <span class="text-xs text-gray-600 font-mono">Sep 2021 - May 2022</span>
                                </div>
                                <p class="text-xs font-semibold text-gray-700 mb-2">Web Developer | Toronto, Canada</p>
                                <ul class="list-disc ml-4 text-sm text-gray-700 space-y-1 leading-snug">
                                    <li>Enhanced OPS Enterprise intranet using VueJS, Go, Docker, Kubernetes, and MariaDB.</li>
                                    <li>Ensured AODA accessibility compliance using WAVE and AXE tools.</li>
                                    <li>Optimized page performance via VueJS component refactoring.</li>
                                </ul>
                            </div>

                             <!-- Job 4 -->
                            <div class="mb-1">
                                <div class="flex justify-between items-baseline">
                                    <h4 class="font-bold text-gray-900 text-sm">Wadi Grocery</h4>
                                    <span class="text-xs text-gray-600 font-mono">2018</span>
                                </div>
                                <p class="text-xs text-gray-600">Procurement Supervisor | Saudi Arabia</p>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar Column -->
                    <div>
                        <!-- Skills -->
                        <div class="mb-6">
                            <h3 class="text-sm font-bold text-blue-800 uppercase tracking-wider border-b border-gray-300 mb-3">Top Skills</h3>
                            <div class="flex flex-wrap gap-2">
                                <span class="bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs font-semibold">TypeScript</span>
                                <span class="bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs font-semibold">AWS Serverless</span>
                                <span class="bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs font-semibold">React / Next.js</span>
                                <span class="bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs font-semibold">Node.js</span>
                                <span class="bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs font-semibold">Docker / CI/CD</span>
                                <span class="bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs font-semibold">Jest</span>
                            </div>
                        </div>

                        <!-- Education -->
                        <div class="mb-6">
                            <h3 class="text-sm font-bold text-blue-800 uppercase tracking-wider border-b border-gray-300 mb-3">Education</h3>
                            <div class="mb-3">
                                <p class="font-bold text-sm text-gray-900">Seneca College</p>
                                <p class="text-xs text-gray-700">Adv. Diploma, Computer Programming & Analysis</p>
                                <p class="text-xs text-gray-500">2019 - 2022</p>
                            </div>
                            <div>
                                <p class="font-bold text-sm text-gray-900">Bangladesh Int. School</p>
                                <p class="text-xs text-gray-700">High School Diploma, IT</p>
                            </div>
                        </div>

                         <!-- Honors -->
                        <div class="mb-6">
                            <h3 class="text-sm font-bold text-blue-800 uppercase tracking-wider border-b border-gray-300 mb-3">Honors</h3>
                             <p class="text-sm text-gray-800"><i class="fa-solid fa-award text-yellow-600 mr-1"></i> President's Honour List</p>
                        </div>

                        <!-- Languages -->
                        <div class="mb-6">
                            <h3 class="text-sm font-bold text-blue-800 uppercase tracking-wider border-b border-gray-300 mb-3">Languages</h3>
                            <ul class="text-xs text-gray-700 space-y-1">
                                <li><strong>English:</strong> Native/Bilingual</li>
                                <li><strong>Bengali:</strong> Native/Bilingual</li>
                                <li><strong>Hindi/Urdu:</strong> Professional</li>
                                <li><strong>Korean:</strong> Limited Working</li>
                                <li><strong>Arabic:</strong> Elementary</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `;
        const TECH_STACK_JSON = JSON.stringify({ "languages": ["TypeScript", "JavaScript", "Node.js"], "frontend": ["React", "Next.js", "Angular", "Tailwind"], "backend": ["AWS Lambda", "API Gateway", "DocumentDB"], "tools": ["Docker", "Jest", "CI/CD", "Git"] }, null, 2);
        const CONTACT_INFO_TXT = `Email: theniaz619@gmail.com\nLinkedIn: linkedin.com/in/mohammed-niaz-ul\nPhone: 647-657-6450`;

        // --- File System Data ---
        const FILE_SYSTEM = {
            'desktop': [
                { name: 'Niaz_Profile', icon: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Niaz', color: '', type: 'folder', target: 'niaz_profile', size: 0 },
                { name: 'Games', icon: 'fa-solid fa-gamepad', color: 'text-purple-400', type: 'folder', target: 'games_folder', size: 0 },
                { name: 'Terminal', icon: 'fa-solid fa-terminal', color: 'text-gray-100', type: 'app', appId: 'terminal', size: 0 },
                { name: 'Chrome', icon: 'fa-brands fa-chrome', color: 'text-blue-500', type: 'app', appId: 'chrome', size: 0 },
            ],
            'niaz_profile': [
                { name: 'Resume.pdf', icon: 'fa-solid fa-file-pdf', color: 'text-red-500', type: 'file', appId: 'pdf-viewer', content: RESUME_CONTENT, size: 245 },
                { name: 'Tech_Stack.json', icon: 'fa-solid fa-file-code', color: 'text-yellow-300', type: 'file', appId: 'notepad', content: TECH_STACK_JSON, size: 12 },
                { name: 'Contact_Info.txt', icon: 'fa-regular fa-address-card', color: 'text-blue-300', type: 'file', appId: 'notepad', content: CONTACT_INFO_TXT, size: 4 },
            ],
            'games_folder': [
                { name: 'Neon Snake 3D', icon: 'fa-solid fa-staff-snake', color: 'text-green-400', type: 'app', appId: 'snake' },
                { name: 'Galactic Defender', icon: 'fa-solid fa-rocket', color: 'text-orange-500', type: 'app', appId: 'shooter' },
                { name: 'Minesweeper', icon: 'fa-solid fa-bomb', color: 'text-red-400', type: 'app', appId: 'minesweeper' },
                { name: 'Tic-Tac-Toe', icon: 'fa-solid fa-hashtag', color: 'text-blue-400', type: 'app', appId: 'tictactoe' }
            ],
            'downloads': [
                { name: 'installer.exe', icon: 'fa-brands fa-windows', color: 'text-blue-300', type: 'file', size: 15400 },
                { name: 'archive.zip', icon: 'fa-solid fa-file-zipper', color: 'text-yellow-200', type: 'file', size: 4500 },
            ],
            'documents': [
                { name: 'Notes.txt', icon: 'fa-regular fa-file-lines', color: 'text-white', type: 'file', appId: 'notepad', content: 'Meeting notes...', size: 2 },
            ],
            'trash': [
                { name: 'Old_Design_v1.png', icon: 'fa-regular fa-image', color: 'text-gray-500', type: 'file', size: 150 },
            ]
        };

        // --- Game Logic: Snake 3D ---
        var snakeGame = {
            interval: null,
            score: 0,
            highScore: 0,
            snake: [],
            food: {},
            direction: 'up',
            gridSize: 20,
            inputHandler: null,
            
            init: function(canvasId, scoreId, highScoreId) {
                const canvas = document.getElementById(canvasId);
                if(!canvas) return;
                this.ctx = canvas.getContext('2d');
                this.width = canvas.width;
                this.height = canvas.height;
                this.scoreEl = document.getElementById(scoreId);
                this.highScoreEl = document.getElementById(highScoreId);
                
                this.snake = [{x: 10, y: 10}, {x: 10, y: 11}, {x: 10, y: 12}];
                this.food = this.randomFood();
                this.direction = 'up';
                this.score = 0;
                this.scoreEl.innerText = 0;
                this.highScoreEl.innerText = this.highScore;
                this.running = false;

                // Input - Properly store listener reference for removal
                if (this.inputHandler) document.removeEventListener('keydown', this.inputHandler);
                
                this.inputHandler = (e) => {
                    const overlay = document.getElementById('snake-overlay');
                    // If overlay is missing, likely window is closed.
                    if (!overlay) return; 
                    
                    if (!this.running && overlay.style.display !== 'none') return;
                    switch(e.key) {
                        case 'ArrowUp': case 'w': if(this.direction !== 'down') this.direction = 'up'; break;
                        case 'ArrowDown': case 's': if(this.direction !== 'up') this.direction = 'down'; break;
                        case 'ArrowLeft': case 'a': if(this.direction !== 'right') this.direction = 'left'; break;
                        case 'ArrowRight': case 'd': if(this.direction !== 'left') this.direction = 'right'; break;
                    }
                };
                document.addEventListener('keydown', this.inputHandler);
            },
            start: function() {
                if(this.interval) clearInterval(this.interval);
                this.running = true;
                this.score = 0;
                this.scoreEl.innerText = 0;
                this.snake = [{x: 10, y: 10}, {x: 10, y: 11}, {x: 10, y: 12}];
                this.food = this.randomFood();
                this.direction = 'up';
                
                const overlay = document.getElementById('snake-overlay');
                if(overlay) overlay.style.display = 'none';
                
                this.interval = setInterval(() => this.update(), 100);
            },
            update: function() {
                const head = { ...this.snake[0] };
                if(this.direction === 'up') head.y--;
                if(this.direction === 'down') head.y++;
                if(this.direction === 'left') head.x--;
                if(this.direction === 'right') head.x++;

                // Wall Collision
                if (head.x < 0 || head.x >= this.gridSize || head.y < 0 || head.y >= this.gridSize) {
                    this.gameOver();
                    return;
                }
                // Self Collision
                if (this.snake.some(s => s.x === head.x && s.y === head.y)) {
                    this.gameOver();
                    return;
                }

                this.snake.unshift(head);

                // Eat Food
                if(head.x === this.food.x && head.y === this.food.y) {
                    this.score += 10;
                    if(this.scoreEl) this.scoreEl.innerText = this.score;
                    this.food = this.randomFood();
                } else {
                    this.snake.pop();
                }

                this.draw();
            },
            draw: function() {
                if (!this.ctx) return;
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.width, this.height);

                // Perspective Projection Helper
                const project = (x, y) => {
                    // Scale: 0.6 (Far/Top) to 1.0 (Near/Bottom)
                    const scale = 0.6 + (y / this.gridSize) * 0.4; 
                    const centerX = this.width / 2;
                    
                    // Fix Tilt: Perfectly center the grid indices (0 to gridSize-1)
                    const centeredX = x - (this.gridSize - 1) / 2;
                    
                    // X Offset based on centered coordinate
                    const xOffset = centeredX * (this.width / this.gridSize) * scale;
                    
                    const sx = centerX + xOffset;
                    const sy = y * (this.height / this.gridSize);
                    return { x: sx, y: sy, scale };
                };

                // Draw Visible Boundary (The Wall)
                this.ctx.strokeStyle = '#004400';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                // Connect the centers of the 4 corner cells to show the valid playable area
                const tl = project(0, 0);
                const tr = project(this.gridSize - 1, 0);
                const br = project(this.gridSize - 1, this.gridSize - 1);
                const bl = project(0, this.gridSize - 1);
                
                this.ctx.moveTo(tl.x, tl.y);
                this.ctx.lineTo(tr.x, tr.y);
                this.ctx.lineTo(br.x, br.y);
                this.ctx.lineTo(bl.x, bl.y);
                this.ctx.closePath();
                this.ctx.stroke();

                // Draw Snake
                this.snake.forEach((seg, i) => {
                    const pos = project(seg.x, seg.y);
                    // Size scales with depth
                    const size = (this.width / this.gridSize) * pos.scale * 0.8; 
                    this.ctx.fillStyle = i === 0 ? '#00ff00' : '#00cc00'; 
                    this.ctx.shadowBlur = 15;
                    this.ctx.shadowColor = '#00ff00';
                    this.ctx.fillRect(pos.x - size/2, pos.y - size/2, size, size);
                    this.ctx.shadowBlur = 0;
                });

                // Draw Food
                const fPos = project(this.food.x, this.food.y);
                const fSize = (this.width / this.gridSize) * fPos.scale * 0.4;
                this.ctx.fillStyle = '#ff00ff';
                this.ctx.shadowBlur = 10;
                this.ctx.shadowColor = '#ff00ff';
                this.ctx.beginPath();
                this.ctx.arc(fPos.x, fPos.y, fSize, 0, Math.PI*2);
                this.ctx.fill();
                this.ctx.shadowBlur = 0;
            },
            randomFood: function() {
                return {
                    x: Math.floor(Math.random() * this.gridSize),
                    y: Math.floor(Math.random() * this.gridSize)
                };
            },
            gameOver: function() {
                clearInterval(this.interval);
                this.running = false;
                if(this.score > this.highScore) {
                    this.highScore = this.score;
                    if(this.highScoreEl) this.highScoreEl.innerText = this.score;
                    sys.saveState(); // Save high score
                }
                const overlay = document.getElementById('snake-overlay');
                if (overlay) {
                    overlay.innerHTML = `
                        <div class="text-red-500 text-2xl mb-4 font-game">GAME OVER</div>
                        <div class="mb-4">Score: ${this.score}</div>
                        <button onclick="snakeGame.start()" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-white font-bold">RESTART</button>
                    `;
                    overlay.style.display = 'flex';
                }
            }
        };

        // --- Game Logic: Space Shooter ---
        var shooterGame = {
            animId: null,
            player: { x: 0, y: 0, w: 40, h: 40, speed: 5 },
            bullets: [],
            enemies: [],
            score: 0,
            health: 100,
            highScore: 0,
            keys: {},
            lastShot: 0,
            spawnTimer: 0,
            keyDownHandler: null,
            keyUpHandler: null,
            
            init: function(canvasId, scoreId, highScoreId, healthId) {
                const canvas = document.getElementById(canvasId);
                if(!canvas) return;
                this.ctx = canvas.getContext('2d');
                this.width = canvas.width;
                this.height = canvas.height;
                this.scoreEl = document.getElementById(scoreId);
                this.healthEl = document.getElementById(healthId);
                this.highScoreEl = document.getElementById(highScoreId);
                if(this.highScoreEl) this.highScoreEl.innerText = this.highScore;

                this.player.x = this.width / 2 - 20;
                this.player.y = this.height - 60;

                if (this.keyDownHandler) window.removeEventListener('keydown', this.keyDownHandler);
                if (this.keyUpHandler) window.removeEventListener('keyup', this.keyUpHandler);

                this.keyDownHandler = e => this.keys[e.key] = true;
                this.keyUpHandler = e => this.keys[e.key] = false;

                window.addEventListener('keydown', this.keyDownHandler);
                window.addEventListener('keyup', this.keyUpHandler);
            },
            start: function() {
                cancelAnimationFrame(this.animId);
                this.score = 0;
                this.health = 100;
                this.bullets = [];
                this.enemies = [];
                if(this.scoreEl) this.scoreEl.innerText = 0;
                if(this.healthEl) this.healthEl.style.width = '100%';
                this.player.x = this.width / 2 - 20;
                const overlay = document.getElementById('shooter-overlay');
                if(overlay) overlay.style.display = 'none';
                this.loop();
            },
            loop: function() {
                this.update();
                this.draw();
                if(this.health > 0) {
                    this.animId = requestAnimationFrame(() => this.loop());
                } else {
                    this.gameOver();
                }
            },
            update: function() {
                if(this.keys['ArrowLeft'] && this.player.x > 0) this.player.x -= this.player.speed;
                if(this.keys['ArrowRight'] && this.player.x < this.width - this.player.w) this.player.x += this.player.speed;
                
                if(this.keys[' '] && Date.now() - this.lastShot > 300) {
                    this.bullets.push({ x: this.player.x + 18, y: this.player.y, w: 4, h: 10, color: '#0ff' });
                    this.lastShot = Date.now();
                }

                this.spawnTimer++;
                if(this.spawnTimer > 60) {
                    const type = Math.random() > 0.5 ? 'asteroid' : 'ship';
                    this.enemies.push({
                        x: Math.random() * (this.width - 40),
                        y: -40,
                        w: type === 'asteroid' ? 30 : 40,
                        h: type === 'asteroid' ? 30 : 30,
                        type: type,
                        hp: type === 'asteroid' ? 1 : 3
                    });
                    this.spawnTimer = 0;
                }

                this.bullets.forEach((b, i) => {
                    b.y -= 7;
                    if(b.y < 0) this.bullets.splice(i, 1);
                });

                this.enemies.forEach((e, i) => {
                    e.y += e.type === 'asteroid' ? 3 : 2;
                    
                    if (this.rectIntersect(this.player, e)) {
                        this.health -= 20;
                        this.updateHealth();
                        this.enemies.splice(i, 1);
                        return;
                    }

                    this.bullets.forEach((b, bi) => {
                        if (this.rectIntersect(b, e)) {
                            e.hp--;
                            this.bullets.splice(bi, 1);
                            if(e.hp <= 0) {
                                this.score += e.type === 'asteroid' ? 50 : 100;
                                if(this.scoreEl) this.scoreEl.innerText = this.score;
                                this.enemies.splice(i, 1);
                            }
                        }
                    });

                    if(e.y > this.height) this.enemies.splice(i, 1);
                });
            },
            draw: function() {
                if(!this.ctx) return;
                this.ctx.fillStyle = '#000022';
                this.ctx.fillRect(0, 0, this.width, this.height);
                
                this.ctx.fillStyle = '#fff';
                if(Math.random() > 0.9) this.ctx.fillRect(Math.random()*this.width, Math.random()*this.height, 2, 2);

                this.ctx.fillStyle = '#00aaff';
                this.ctx.beginPath();
                this.ctx.moveTo(this.player.x + 20, this.player.y);
                this.ctx.lineTo(this.player.x + 40, this.player.y + 40);
                this.ctx.lineTo(this.player.x, this.player.y + 40);
                this.ctx.fill();

                this.bullets.forEach(b => {
                    this.ctx.fillStyle = b.color;
                    this.ctx.fillRect(b.x, b.y, b.w, b.h);
                });

                this.enemies.forEach(e => {
                    if(e.type === 'asteroid') {
                        this.ctx.fillStyle = '#888';
                        this.ctx.beginPath();
                        this.ctx.arc(e.x + 15, e.y + 15, 15, 0, Math.PI*2);
                        this.ctx.fill();
                    } else {
                        this.ctx.fillStyle = '#ff4444';
                        this.ctx.fillRect(e.x, e.y, e.w, e.h);
                    }
                });
            },
            rectIntersect: function(r1, r2) {
                return !(r2.x > r1.x + r1.w || r2.x + r2.w < r1.x || r2.y > r1.y + r1.h || r2.y + r2.h < r1.y);
            },
            updateHealth: function() {
                if(!this.healthEl) return;
                this.healthEl.style.width = `${Math.max(0, this.health)}%`;
                if(this.health <= 30) this.healthEl.className = 'h-full bg-red-500 transition-all duration-200';
                else this.healthEl.className = 'h-full bg-green-500 transition-all duration-200';
            },
            gameOver: function() {
                if(this.score > this.highScore) {
                    this.highScore = this.score;
                    if(this.highScoreEl) this.highScoreEl.innerText = this.score;
                    sys.saveState(); // Save high score
                }
                const overlay = document.getElementById('shooter-overlay');
                if(overlay) {
                    overlay.innerHTML = `
                        <div class="text-red-500 text-2xl mb-4 font-game">MISSION FAILED</div>
                        <div class="mb-4">Score: ${this.score}</div>
                        <button onclick="shooterGame.start()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white font-bold">REDEPLOY</button>
                    `;
                    overlay.style.display = 'flex';
                }
            }
        };

        // --- Game Logic: Minesweeper ---
        var minesweeperGame = {
            grid: [],
            gridSize: 10,
            mineCount: 15,
            revealed: 0,
            flagged: 0,
            gameOver: false,
            won: false,
            
            init: function(containerId, mineCountId, timerDisplay) {
                this.container = document.getElementById(containerId);
                this.mineCountDisplay = document.getElementById(mineCountId);
                this.timerDisplay = document.getElementById(timerDisplay);
                this.reset();
            },
            
            reset: function() {
                this.grid = [];
                this.revealed = 0;
                this.flagged = 0;
                this.gameOver = false;
                this.won = false;
                this.timer = 0;
                clearInterval(this.timerInterval);
                
                // Initialize grid
                for(let i = 0; i < this.gridSize; i++) {
                    this.grid[i] = [];
                    for(let j = 0; j < this.gridSize; j++) {
                        this.grid[i][j] = {
                            mine: false,
                            revealed: false,
                            flagged: false,
                            neighborMines: 0
                        };
                    }
                }
                
                // Place mines
                let placed = 0;
                while(placed < this.mineCount) {
                    const row = Math.floor(Math.random() * this.gridSize);
                    const col = Math.floor(Math.random() * this.gridSize);
                    if(!this.grid[row][col].mine) {
                        this.grid[row][col].mine = true;
                        placed++;
                    }
                }
                
                // Calculate neighbor counts
                for(let i = 0; i < this.gridSize; i++) {
                    for(let j = 0; j < this.gridSize; j++) {
                        if(!this.grid[i][j].mine) {
                            this.grid[i][j].neighborMines = this.countNeighborMines(i, j);
                        }
                    }
                }
                
                this.render();
                if(this.mineCountDisplay) this.mineCountDisplay.innerText = this.mineCount;
                if(this.timerDisplay) this.timerDisplay.innerText = '000';
            },
            
            countNeighborMines: function(row, col) {
                let count = 0;
                for(let i = -1; i <= 1; i++) {
                    for(let j = -1; j <= 1; j++) {
                        if(i === 0 && j === 0) continue;
                        const newRow = row + i;
                        const newCol = col + j;
                        if(newRow >= 0 && newRow < this.gridSize && newCol >= 0 && newCol < this.gridSize) {
                            if(this.grid[newRow][newCol].mine) count++;
                        }
                    }
                }
                return count;
            },
            
            reveal: function(row, col) {
                if(this.gameOver || this.won) return;
                if(this.grid[row][col].revealed || this.grid[row][col].flagged) return;
                
                // Start timer on first click
                if(this.revealed === 0) {
                    this.timerInterval = setInterval(() => {
                        this.timer++;
                        if(this.timerDisplay) this.timerDisplay.innerText = String(this.timer).padStart(3, '0');
                    }, 1000);
                }
                
                this.grid[row][col].revealed = true;
                this.revealed++;
                
                if(this.grid[row][col].mine) {
                    this.gameOver = true;
                    clearInterval(this.timerInterval);
                    this.revealAll();
                    this.render();
                    setTimeout(() => alert('💣 Game Over! You hit a mine!'), 100);
                    return;
                }
                
                // Auto-reveal neighbors if no mines nearby
                if(this.grid[row][col].neighborMines === 0) {
                    for(let i = -1; i <= 1; i++) {
                        for(let j = -1; j <= 1; j++) {
                            if(i === 0 && j === 0) continue;
                            const newRow = row + i;
                            const newCol = col + j;
                            if(newRow >= 0 && newRow < this.gridSize && newCol >= 0 && newCol < this.gridSize) {
                                this.reveal(newRow, newCol);
                            }
                        }
                    }
                }
                
                // Check win condition
                if(this.revealed === this.gridSize * this.gridSize - this.mineCount) {
                    this.won = true;
                    clearInterval(this.timerInterval);
                    setTimeout(() => alert('🎉 You Win! All mines found!'), 100);
                }
                
                this.render();
            },
            
            flag: function(row, col) {
                if(this.gameOver || this.won) return;
                if(this.grid[row][col].revealed) return;
                
                this.grid[row][col].flagged = !this.grid[row][col].flagged;
                this.flagged += this.grid[row][col].flagged ? 1 : -1;
                
                if(this.mineCountDisplay) {
                    this.mineCountDisplay.innerText = this.mineCount - this.flagged;
                }
                
                this.render();
            },
            
            revealAll: function() {
                for(let i = 0; i < this.gridSize; i++) {
                    for(let j = 0; j < this.gridSize; j++) {
                        this.grid[i][j].revealed = true;
                    }
                }
            },
            
            render: function() {
                if(!this.container) return;
                this.container.innerHTML = '';
                
                for(let i = 0; i < this.gridSize; i++) {
                    for(let j = 0; j < this.gridSize; j++) {
                        const cell = this.grid[i][j];
                        const btn = document.createElement('button');
                        btn.className = 'w-8 h-8 border border-gray-400 flex items-center justify-center text-xs font-bold transition';
                        
                        if(cell.revealed) {
                            if(cell.mine) {
                                btn.className += ' bg-red-500 text-white';
                                btn.innerHTML = '💣';
                            } else {
                                btn.className += ' bg-gray-200 text-gray-800';
                                if(cell.neighborMines > 0) {
                                    btn.innerText = cell.neighborMines;
                                    // Color based on number
                                    const colors = ['', 'text-blue-600', 'text-green-600', 'text-red-600', 'text-purple-600', 'text-yellow-600'];
                                    btn.className += ' ' + (colors[cell.neighborMines] || 'text-gray-800');
                                }
                            }
                        } else {
                            btn.className += ' bg-gray-400 hover:bg-gray-500 active:bg-gray-300';
                            if(cell.flagged) {
                                btn.innerHTML = '🚩';
                            }
                            btn.onclick = () => this.reveal(i, j);
                            btn.oncontextmenu = (e) => {
                                e.preventDefault();
                                this.flag(i, j);
                            };
                        }
                        
                        this.container.appendChild(btn);
                    }
                }
            }
        };

        // --- Game Logic: Tic-Tac-Toe ---
        var ticTacToeGame = {
            board: [],
            currentPlayer: 'X',
            gameOver: false,
            xWins: 0,
            oWins: 0,
            
            init: function(boardId, statusId, xWinsId, oWinsId) {
                this.boardEl = document.getElementById(boardId);
                this.statusEl = document.getElementById(statusId);
                this.xWinsEl = document.getElementById(xWinsId);
                this.oWinsEl = document.getElementById(oWinsId);
                this.reset();
            },
            
            reset: function() {
                this.board = Array(9).fill(null);
                this.currentPlayer = 'X';
                this.gameOver = false;
                if(this.statusEl) this.statusEl.innerText = "Player X's Turn";
                this.render();
            },
            
            makeMove: function(index) {
                if(this.gameOver || this.board[index]) return;
                
                this.board[index] = this.currentPlayer;
                this.render();
                
                if(this.checkWinner()) {
                    this.gameOver = true;
                    if(this.statusEl) this.statusEl.innerText = `Player ${this.currentPlayer} Wins! 🎉`;
                    if(this.currentPlayer === 'X') {
                        this.xWins++;
                        if(this.xWinsEl) this.xWinsEl.innerText = this.xWins;
                    } else {
                        this.oWins++;
                        if(this.oWinsEl) this.oWinsEl.innerText = this.oWins;
                    }
                    return;
                }
                
                if(this.board.every(cell => cell !== null)) {
                    this.gameOver = true;
                    if(this.statusEl) this.statusEl.innerText = "It's a Draw! 🤝";
                    return;
                }
                
                this.currentPlayer = this.currentPlayer === 'X' ? 'O' : 'X';
                if(this.statusEl) this.statusEl.innerText = `Player ${this.currentPlayer}'s Turn`;
            },
            
            checkWinner: function() {
                const lines = [
                    [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
                    [0, 3, 6], [1, 4, 7], [2, 5, 8], // Cols
                    [0, 4, 8], [2, 4, 6]             // Diagonals
                ];
                
                for(let line of lines) {
                    const [a, b, c] = line;
                    if(this.board[a] && this.board[a] === this.board[b] && this.board[a] === this.board[c]) {
                        return true;
                    }
                }
                return false;
            },
            
            render: function() {
                if(!this.boardEl) return;
                this.boardEl.innerHTML = '';
                
                this.board.forEach((cell, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'w-20 h-20 bg-white border-2 border-gray-800 text-4xl font-bold hover:bg-gray-100 transition flex items-center justify-center';
                    btn.innerText = cell || '';
                    btn.onclick = () => this.makeMove(index);
                    
                    if(cell === 'X') {
                        btn.className += ' text-blue-600';
                    } else if(cell === 'O') {
                        btn.className += ' text-red-600';
                    }
                    
                    this.boardEl.appendChild(btn);
                });
            }
        };

        // --- Particle System for Animated Background ---
        class ParticleSystem {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.particles = [];
                this.particleCount = 100;
                this.running = false;
                this.resize();
                window.addEventListener('resize', () => this.resize());
            }
            
            resize() {
                const uiRoot = document.getElementById('ui-root');
                this.canvas.width = uiRoot.offsetWidth;
                this.canvas.height = uiRoot.offsetHeight;
            }
            
            start() {
                if (this.running) return;
                this.running = true;
                this.particles = [];
                
                for (let i = 0; i < this.particleCount; i++) {
                    this.particles.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height,
                        vx: (Math.random() - 0.5) * 0.5,
                        vy: (Math.random() - 0.5) * 0.5,
                        radius: Math.random() * 2 + 1,
                        color: `hsl(${Math.random() * 60 + 180}, 70%, 60%)`
                    });
                }
                
                this.animate();
            }
            
            stop() {
                this.running = false;
            }
            
            animate() {
                if (!this.running) return;
                
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    
                    if (p.x < 0 || p.x > this.canvas.width) p.vx *= -1;
                    if (p.y < 0 || p.y > this.canvas.height) p.vy *= -1;
                    
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    this.ctx.fillStyle = p.color;
                    this.ctx.fill();
                    
                    // Draw connections
                    this.particles.forEach(p2 => {
                        const dx = p.x - p2.x;
                        const dy = p.y - p2.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist < 100) {
                            this.ctx.beginPath();
                            this.ctx.moveTo(p.x, p.y);
                            this.ctx.lineTo(p2.x, p2.y);
                            this.ctx.strokeStyle = `rgba(96, 205, 255, ${1 - dist / 100})`;
                            this.ctx.lineWidth = 0.5;
                            this.ctx.stroke();
                        }
                    });
                });
                
                requestAnimationFrame(() => this.animate());
            }
        }

        // --- App Logic Objects (Defined as VAR to ensure visibility) ---
        var fileExplorer = {
            init: function(winId, folderName) { this.nav(winId, folderName); },
            nav: function(winId, folderName) {
                const grid = document.getElementById(`grid-${winId}`);
                const path = document.getElementById(`path-${winId}`);
                if(!grid) return;
                path.innerText = `PC > ${folderName.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
                grid.innerHTML = '';
                (FILE_SYSTEM[folderName] || []).forEach(file => {
                    const el = document.createElement('div');
                    el.className = 'flex flex-col items-center gap-1 p-2 hover:bg-white/10 rounded group cursor-default';
                    let iconHtml = file.icon.startsWith('http') 
                        ? `<img src="${file.icon}" class="w-10 h-10 rounded-full mb-2 shadow-md">` 
                        : `<i class="${file.icon} ${file.color} text-4xl mb-1"></i>`;
                    el.innerHTML = `${iconHtml}<span class="text-xs text-center w-full truncate group-hover:text-white text-gray-200">${file.name}</span>`;
                    el.ondblclick = () => file.type === 'folder' ? fileExplorer.nav(winId, file.target) : wm.openWindow(file.appId, file);
                    grid.appendChild(el);
                });
            },
            up: function(winId) { this.nav(winId, 'desktop'); }
        };

        var terminalApp = {
            history: [],
            historyIndex: -1,
            currentDir: '~',
            
            init: function(winId) {
                this.winId = winId;
                const outEl = document.getElementById(`term-output-${winId}`);
                if (!outEl) return;
                
                outEl.innerHTML = `
                    <div class="text-green-400 mb-2">NiazOS Terminal v1.0</div>
                    <div class="text-gray-400 text-sm mb-4">Type 'help' for available commands</div>
                    <div class="flex items-center">
                        <span class="text-blue-400">niaz@portfolio</span>
                        <span class="text-white">:</span>
                        <span class="text-purple-400" id="term-dir-${winId}">~</span>
                        <span class="text-white">$ </span>
                        <input type="text" id="term-input-${winId}" class="flex-1 bg-transparent border-none outline-none text-green-400 font-mono ml-1" autofocus>
                    </div>
                    <div id="term-history-${winId}"></div>
                `;
                
                const input = document.getElementById(`term-input-${winId}`);
                if (input) {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            this.executeCommand(input.value.trim());
                            input.value = '';
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            if (this.historyIndex < this.history.length - 1) {
                                this.historyIndex++;
                                input.value = this.history[this.history.length - 1 - this.historyIndex];
                            }
                        } else if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            if (this.historyIndex > 0) {
                                this.historyIndex--;
                                input.value = this.history[this.history.length - 1 - this.historyIndex];
                            } else {
                                this.historyIndex = -1;
                                input.value = '';
                            }
                        }
                    });
                    input.focus();
                }
            },
            
            executeCommand: function(cmd) {
                if (!cmd) return;
                
                this.history.push(cmd);
                this.historyIndex = -1;
                
                const historyEl = document.getElementById(`term-history-${this.winId}`);
                const parts = cmd.split(' ');
                const command = parts[0].toLowerCase();
                const args = parts.slice(1);
                
                let output = '';
                
                switch(command) {
                    case 'help':
                        output = `
<div class="text-cyan-400 font-bold mb-2">Available Commands:</div>
<div class="grid grid-cols-2 gap-2 text-sm">
  <div><span class="text-yellow-400">ls</span> - List directory contents</div>
  <div><span class="text-yellow-400">cd</span> - Change directory</div>
  <div><span class="text-yellow-400">cat</span> - Display file contents</div>
  <div><span class="text-yellow-400">pwd</span> - Print working directory</div>
  <div><span class="text-yellow-400">whoami</span> - Display user info</div>
  <div><span class="text-yellow-400">skills</span> - List technical skills</div>
  <div><span class="text-yellow-400">projects</span> - Show portfolio projects</div>
  <div><span class="text-yellow-400">contact</span> - Display contact info</div>
  <div><span class="text-yellow-400">clear</span> - Clear terminal</div>
  <div><span class="text-yellow-400">neofetch</span> - System info (ASCII art)</div>
  <div><span class="text-yellow-400">echo</span> - Print text</div>
  <div><span class="text-yellow-400">date</span> - Show current date/time</div>
</div>`;
                        break;
                    
                    case 'ls':
                        const dirs = ['Desktop', 'Documents', 'Downloads', 'Games', 'Projects'];
                        output = `<div class="grid grid-cols-3 gap-2">${dirs.map(d => `<div class="text-blue-400">📁 ${d}</div>`).join('')}</div>`;
                        break;
                    
                    case 'cd':
                        if (!args[0]) {
                            this.currentDir = '~';
                        } else if (args[0] === '..') {
                            this.currentDir = '~';
                        } else {
                            this.currentDir = args[0];
                        }
                        document.getElementById(`term-dir-${this.winId}`).innerText = this.currentDir;
                        break;
                    
                    case 'pwd':
                        output = `<div class="text-white">/home/niaz/${this.currentDir}</div>`;
                        break;
                    
                    case 'whoami':
                        output = `
<div class="text-cyan-400 font-bold text-lg mb-2">Mohammed Niaz Ul Haque</div>
<div class="text-white">Full Stack Engineer @ Fourth Dimension (4D)</div>
<div class="text-gray-400">Location: Toronto, Canada 🇨🇦</div>
<div class="text-gray-400 mt-2">Building secure, high-performing web platforms</div>`;
                        break;
                    
                    case 'skills':
                        output = `
<div class="text-yellow-400 font-bold mb-2">🚀 Technical Skills:</div>
<div class="ml-4">
  <div class="text-green-400">Languages:</div>
  <div class="ml-4 text-gray-300">TypeScript • JavaScript • Node.js • Python • C#</div>
  
  <div class="text-green-400 mt-2">Frontend:</div>
  <div class="ml-4 text-gray-300">React • Next.js • Angular • Vue.js • Tailwind CSS</div>
  
  <div class="text-green-400 mt-2">Backend:</div>
  <div class="ml-4 text-gray-300">AWS Lambda • API Gateway • DocumentDB • Express</div>
  
  <div class="text-green-400 mt-2">Tools & DevOps:</div>
  <div class="ml-4 text-gray-300">Docker • Kubernetes • Git • Jest • CI/CD</div>
</div>`;
                        break;
                    
                    case 'projects':
                        output = `
<div class="text-purple-400 font-bold mb-2">💼 Portfolio Projects:</div>
<div class="space-y-2 ml-4">
  <div class="border-l-2 border-blue-400 pl-2">
    <div class="text-white font-semibold">Multi-Tenant Plugin Platform</div>
    <div class="text-gray-400 text-sm">Event-driven architecture • AWS Serverless • React</div>
  </div>
  <div class="border-l-2 border-green-400 pl-2">
    <div class="text-white font-semibold">MerlinPay Payment Platform</div>
    <div class="text-gray-400 text-sm">B2B/B2C payments • Vue.js • OAuth2</div>
  </div>
  <div class="border-l-2 border-yellow-400 pl-2">
    <div class="text-white font-semibold">OPS Enterprise Intranet</div>
    <div class="text-gray-400 text-sm">VueJS • Go • Docker • Kubernetes • AODA compliant</div>
  </div>
</div>`;
                        break;
                    
                    case 'contact':
                        output = `
<div class="text-pink-400 font-bold mb-2">📧 Contact Information:</div>
<div class="ml-4 space-y-1">
  <div>📧 Email: <span class="text-cyan-400">theniaz619@gmail.com</span></div>
  <div>💼 LinkedIn: <span class="text-cyan-400">linkedin.com/in/mohammed-niaz-ul</span></div>
  <div>📱 Phone: <span class="text-cyan-400">647-657-6450</span></div>
  <div>📍 Location: <span class="text-cyan-400">Scarborough, Ontario, Canada</span></div>
</div>`;
                        break;
                    
                    case 'clear':
                        historyEl.innerHTML = '';
                        return;
                    
                    case 'neofetch':
                        output = `
<div class="grid grid-cols-2 gap-4">
  <div class="text-cyan-400 font-mono text-xs leading-tight">
       _____<br>
      /     \\<br>
     | () () |<br>
      \\  ^  /<br>
       |||||<br>
       |||||
  </div>
  <div class="text-sm">
    <div><span class="text-cyan-400">OS:</span> NiazOS v1.0</div>
    <div><span class="text-cyan-400">User:</span> Mohammed Niaz</div>
    <div><span class="text-cyan-400">Shell:</span> bash 5.1</div>
    <div><span class="text-cyan-400">Role:</span> Full Stack Engineer</div>
    <div><span class="text-cyan-400">Uptime:</span> ∞ (Always learning)</div>
    <div><span class="text-cyan-400">Stack:</span> MERN + AWS</div>
  </div>
</div>`;
                        break;
                    
                    case 'echo':
                        output = `<div class="text-white">${args.join(' ')}</div>`;
                        break;
                    
                    case 'date':
                        output = `<div class="text-white">${new Date().toString()}</div>`;
                        break;
                    
                    case 'cat':
                        if (!args[0]) {
                            output = `<div class="text-red-400">cat: missing file operand</div>`;
                        } else {
                            output = `<div class="text-red-400">cat: ${args[0]}: No such file or directory</div>`;
                        }
                        break;
                    
                    default:
                        output = `<div class="text-red-400">Command not found: ${command}</div><div class="text-gray-400">Type 'help' for available commands</div>`;
                }
                
                historyEl.innerHTML += `
                    <div class="mt-2">
                        <div class="flex items-center text-gray-400">
                            <span class="text-blue-400">niaz@portfolio</span>
                            <span>:</span>
                            <span class="text-purple-400">${this.currentDir}</span>
                            <span>$ ${cmd}</span>
                        </div>
                        <div class="ml-4 mt-1">${output}</div>
                    </div>
                `;
                
                // Scroll to bottom
                const container = document.getElementById(`term-output-${this.winId}`).parentElement;
                if (container) container.scrollTop = container.scrollHeight;
            }
        };

        var chromeApp = { 
            go: function(winId) { 
                const iframe = document.getElementById(`iframe-${winId}`);
                if (iframe) iframe.src = "https://www.google.com/webhp?igu=1"; 
            }, 
            refresh: function(winId) { this.go(winId); } 
        };
        var paintApp = {
            canvases: {},
            init: function(id) {
                const canvas = document.getElementById(`canvas-${id}`);
                if (!canvas) return;
                
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                
                const ctx = canvas.getContext('2d');
                this.canvases[id] = { canvas, ctx, drawing: false, tool: 'pen' };
                
                canvas.addEventListener('mousedown', (e) => this.startDraw(id, e));
                canvas.addEventListener('mousemove', (e) => this.draw(id, e));
                canvas.addEventListener('mouseup', () => this.stopDraw(id));
                canvas.addEventListener('mouseleave', () => this.stopDraw(id));
            },
            setTool: function(id, tool) {
                this.canvases[id].tool = tool;
                document.getElementById(`tool-pen-${id}`).className = tool === 'pen' ? 'px-3 py-1 bg-blue-500 text-white border border-gray-400 rounded text-xs' : 'px-3 py-1 bg-white border border-gray-400 hover:bg-gray-100 rounded text-xs text-black';
                document.getElementById(`tool-eraser-${id}`).className = tool === 'eraser' ? 'px-3 py-1 bg-blue-500 text-white border border-gray-400 rounded text-xs' : 'px-3 py-1 bg-white border border-gray-400 hover:bg-gray-100 rounded text-xs text-black';
            },
            startDraw: function(id, e) {
                const data = this.canvases[id];
                data.drawing = true;
                const rect = data.canvas.getBoundingClientRect();
                data.lastX = e.clientX - rect.left;
                data.lastY = e.clientY - rect.top;
            },
            draw: function(id, e) {
                const data = this.canvases[id];
                if (!data.drawing) return;
                
                const rect = data.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                data.ctx.beginPath();
                data.ctx.moveTo(data.lastX, data.lastY);
                data.ctx.lineTo(x, y);
                data.ctx.strokeStyle = data.tool === 'pen' ? document.getElementById(`color-${id}`).value : '#ffffff';
                data.ctx.lineWidth = document.getElementById(`size-${id}`).value;
                data.ctx.lineCap = 'round';
                data.ctx.stroke();
                
                data.lastX = x;
                data.lastY = y;
            },
            stopDraw: function(id) {
                if (this.canvases[id]) this.canvases[id].drawing = false;
            },
            clear: function(id) {
                const data = this.canvases[id];
                if (data) data.ctx.clearRect(0, 0, data.canvas.width, data.canvas.height);
            }
        };
        
        var calcApp = {
            states: {},
            clear: function(id) {
                this.states[id] = { display: '0', current: '0', operator: null, prev: null };
                document.getElementById(`calc-display-${id}`).innerText = '0';
            },
            backspace: function(id) {
                if (!this.states[id]) this.clear(id);
                const state = this.states[id];
                state.current = state.current.length > 1 ? state.current.slice(0, -1) : '0';
                document.getElementById(`calc-display-${id}`).innerText = state.current;
            },
            num: function(id, n) {
                if (!this.states[id]) this.clear(id);
                const state = this.states[id];
                if (state.current === '0' && n !== '.') {
                    state.current = n;
                } else if (n === '.' && state.current.includes('.')) {
                    return;
                } else {
                    state.current += n;
                }
                document.getElementById(`calc-display-${id}`).innerText = state.current;
            },
            op: function(id, operator) {
                if (!this.states[id]) this.clear(id);
                const state = this.states[id];
                if (state.operator && state.prev !== null) {
                    this.solve(id);
                }
                state.prev = parseFloat(state.current);
                state.operator = operator;
                state.current = '0';
            },
            solve: function(id) {
                if (!this.states[id]) return;
                const state = this.states[id];
                if (state.operator && state.prev !== null) {
                    const current = parseFloat(state.current);
                    let result = 0;
                    switch(state.operator) {
                        case '+': result = state.prev + current; break;
                        case '-': result = state.prev - current; break;
                        case '*': result = state.prev * current; break;
                        case '/': result = current !== 0 ? state.prev / current : 'Error'; break;
                    }
                    state.current = result.toString();
                    state.operator = null;
                    state.prev = null;
                    document.getElementById(`calc-display-${id}`).innerText = state.current;
                }
            }
        };

        // --- Helper Function ---
        function generateExplorerHTML(winId, startFolder, title) {
            return `
                <div class="flex h-full bg-[#191919] text-white">
                    <!-- Sidebar -->
                    <div class="w-48 bg-[#202020] border-r border-white/5 p-2 text-sm hidden md:block">
                        <div class="p-2 hover:bg-white/10 rounded cursor-pointer flex items-center gap-2" onclick="fileExplorer.nav('${winId}', 'desktop')"><i class="fa-solid fa-desktop text-purple-400"></i> Desktop</div>
                        <div class="p-2 hover:bg-white/10 rounded cursor-pointer flex items-center gap-2" onclick="fileExplorer.nav('${winId}', 'niaz_profile')"><i class="fa-solid fa-id-card text-teal-400"></i> Niaz Profile</div>
                        <div class="p-2 hover:bg-white/10 rounded cursor-pointer flex items-center gap-2" onclick="fileExplorer.nav('${winId}', 'downloads')"><i class="fa-solid fa-download text-green-400"></i> Downloads</div>
                        <div class="p-2 hover:bg-white/10 rounded cursor-pointer flex items-center gap-2" onclick="fileExplorer.nav('${winId}', 'documents')"><i class="fa-regular fa-file text-white"></i> Documents</div>
                    </div>
                    <!-- Main Content -->
                    <div class="flex-1 flex flex-col">
                        <!-- Toolbar -->
                        <div class="h-10 border-b border-white/5 flex items-center px-4 gap-4 text-xs">
                            <button class="hover:bg-white/10 p-1 rounded flex items-center gap-2"><i class="fa-solid fa-plus text-blue-400"></i> New</button>
                            <div class="h-4 w-px bg-white/10"></div>
                            <button class="hover:bg-white/10 p-1 rounded" onclick="fileExplorer.up('${winId}')"><i class="fa-solid fa-arrow-up"></i> Up</button>
                        </div>
                        <!-- Breadcrumb -->
                        <div class="h-10 border-b border-white/5 flex items-center px-4 text-sm gap-2 bg-[#202020]">
                            <i class="fa-solid fa-arrow-up text-gray-400 hover:text-white cursor-pointer" onclick="fileExplorer.up('${winId}')"></i>
                            <div class="bg-[#2b2b2b] px-2 py-1 rounded w-full border border-white/5 flex items-center gap-2 text-xs">
                                <i class="fa-solid fa-computer"></i> <span id="path-${winId}">${title} > ${startFolder}</span>
                            </div>
                        </div>
                        <!-- Grid -->
                        <div class="flex-1 p-4 grid grid-cols-4 md:grid-cols-6 gap-4 content-start overflow-auto" id="grid-${winId}" data-current="${startFolder}">
                            <!-- Filled by JS -->
                        </div>
                    </div>
                </div>
            `;
        }

        const APPS = {
            'notepad': { id: 'notepad', name: 'Text Editor', icon: 'fa-regular fa-file-lines', color: 'text-blue-400', width: 28, height: 22, content: (id, d) => `<textarea class="w-full h-full bg-[#282828] text-white p-4 outline-none font-mono resize-none">${d.content}</textarea>` },
            'pdf-viewer': { id: 'pdf-viewer', name: 'Resume Viewer', icon: 'fa-solid fa-file-pdf', color: 'text-red-500', width: 45, height: 38, content: (id, d) => `<div class="h-full overflow-auto bg-[#525659] p-8 flex justify-center scrollbar-fix"><div class="bg-white text-black p-8 max-w-3xl min-h-fit shadow-lg">${d.content}</div></div>` },
            'terminal': { id: 'terminal', name: 'Terminal', icon: 'fa-solid fa-terminal', color: 'text-gray-100', width: 35, height: 24, content: (id) => `<div class="h-full bg-black text-green-400 font-mono p-4 text-sm overflow-auto" id="term-output-${id}"></div>` },
            'chrome': { id: 'chrome', name: 'Chrome', icon: 'fa-brands fa-chrome', color: 'text-blue-500', width: 42, height: 28, content: (id) => `<div class="h-full flex flex-col bg-white"><div class="h-full relative"><iframe id="iframe-${id}" class="w-full h-full border-none"></iframe><div class="absolute inset-0 pointer-events-none iframe-blocker"></div></div></div>` },
            'explorer': { id: 'explorer', name: 'Explorer', icon: 'fa-solid fa-folder', color: 'text-yellow-400', width: 38, height: 26, content: (id) => generateExplorerHTML(id, 'desktop', 'Desktop') },
            
            // --- NEW GAMES ---
            'snake': {
                id: 'snake', name: 'Neon Snake 3D', icon: 'fa-solid fa-staff-snake', color: 'text-green-400', width: 25, height: 30,
                content: (id) => {
                    setTimeout(() => snakeGame.init(`c-${id}`, `s-${id}`, `hs-${id}`), 100);
                    return `
                    <div class="flex flex-col h-full bg-black relative font-game select-none text-white">
                        <div class="absolute top-2 left-4 z-10 text-xs">
                            SCORE: <span id="s-${id}" class="text-green-400">0</span>
                        </div>
                        <div class="absolute top-2 right-4 z-10 text-xs text-right">
                            HIGH: <span id="hs-${id}" class="text-yellow-400">0</span>
                        </div>
                        <div id="snake-overlay" class="absolute inset-0 z-20 bg-black/80 flex flex-col items-center justify-center">
                            <div class="text-green-500 text-3xl mb-2 font-bold tracking-widest">SNAKE 3D</div>
                            <div class="text-gray-400 text-xs mb-6">WASD / Arrows to Move</div>
                            <button onclick="snakeGame.start()" class="px-6 py-2 border-2 border-green-500 text-green-500 hover:bg-green-500 hover:text-black transition font-bold rounded">START GAME</button>
                        </div>
                        <canvas id="c-${id}" width="600" height="600" class="w-full h-full object-contain"></canvas>
                    </div>`;
                }
            },
            'shooter': {
                id: 'shooter', name: 'Galactic Defender', icon: 'fa-solid fa-rocket', color: 'text-orange-500', width: 24, height: 32,
                content: (id) => {
                    setTimeout(() => shooterGame.init(`c-${id}`, `s-${id}`, `hs-${id}`, `hp-${id}`), 100);
                    return `
                    <div class="flex flex-col h-full bg-[#000022] relative font-game select-none text-white overflow-hidden">
                        <div class="absolute top-0 w-full h-1 bg-gray-800"><div id="hp-${id}" class="h-full bg-green-500 transition-all duration-200" style="width:100%"></div></div>
                        <div class="absolute top-3 left-3 z-10 text-xs">SCORE: <span id="s-${id}">0</span></div>
                        <div class="absolute top-3 right-3 z-10 text-xs">HI: <span id="hs-${id}">0</span></div>
                        <div id="shooter-overlay" class="absolute inset-0 z-20 bg-black/80 flex flex-col items-center justify-center">
                            <div class="text-blue-400 text-xl mb-2 font-bold text-center">GALACTIC<br>DEFENDER</div>
                            <div class="text-gray-400 text-[10px] mb-6 text-center">Arrows to Move<br>Space to Shoot</div>
                            <button onclick="shooterGame.start()" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white font-bold text-xs">LAUNCH MISSION</button>
                        </div>
                        <canvas id="c-${id}" width="480" height="720" class="w-full h-full object-contain"></canvas>
                    </div>`;
                }
            },
            'settings': { id: 'settings', name: 'Settings', icon: 'fa-solid fa-gear', color: 'text-gray-400', width: 38, height: 26, content: (id, d) => settingsApp.render(id, d.tab || 'system') },
            'paint': { 
                id: 'paint', name: 'Paint', icon: 'fa-solid fa-paintbrush', color: 'text-pink-400', width: 32, height: 24,
                content: (id) => {
                    setTimeout(() => paintApp.init(id), 100);
                    return `
                    <div class="flex flex-col h-full bg-[#f0f0f0]">
                        <div class="h-10 bg-[#e0e0e0] border-b border-gray-300 flex items-center gap-2 px-2">
                            <div class="flex gap-1">
                                <button onclick="paintApp.setTool('${id}', 'pen')" class="px-3 py-1 bg-white border border-gray-400 hover:bg-gray-100 rounded text-xs text-black" id="tool-pen-${id}">Pen</button>
                                <button onclick="paintApp.setTool('${id}', 'eraser')" class="px-3 py-1 bg-white border border-gray-400 hover:bg-gray-100 rounded text-xs text-black" id="tool-eraser-${id}">Eraser</button>
                            </div>
                            <div class="h-6 w-px bg-gray-400"></div>
                            <input type="color" id="color-${id}" value="#000000" class="w-8 h-8 cursor-pointer border border-gray-400 rounded">
                            <input type="range" id="size-${id}" min="1" max="20" value="3" class="w-24">
                            <button onclick="paintApp.clear('${id}')" class="px-3 py-1 bg-white border border-gray-400 hover:bg-gray-100 rounded text-xs text-black ml-auto">Clear</button>
                        </div>
                        <canvas id="canvas-${id}" class="flex-1 bg-white cursor-crosshair"></canvas>
                    </div>`;
                }
            },
            'calculator': {
                id: 'calculator', name: 'Calculator', icon: 'fa-solid fa-calculator', color: 'text-blue-300', width: 18, height: 26,
                content: (id) => `
                <div class="flex flex-col h-full bg-[#f0f0f0] p-2 gap-2 select-none">
                    <div class="bg-white border-2 border-gray-400 p-4 text-right text-2xl font-mono h-16 flex items-center justify-end shadow-inner text-black" id="calc-display-${id}">0</div>
                    <div class="grid grid-cols-4 gap-2 flex-1">
                        <button onclick="calcApp.clear('${id}')" class="bg-red-400 hover:bg-red-500 text-white font-bold rounded shadow-md active:shadow-inner col-span-2">C</button>
                        <button onclick="calcApp.backspace('${id}')" class="bg-orange-400 hover:bg-orange-500 text-white font-bold rounded shadow-md active:shadow-inner">←</button>
                        <button onclick="calcApp.op('${id}', '/')" class="bg-gray-300 hover:bg-gray-400 text-black font-bold rounded shadow-md active:shadow-inner">/</button>
                        <button onclick="calcApp.num('${id}', '7')" class="bg-white hover:bg-gray-100 text-black font-bold rounded shadow-md active:shadow-inner border border-gray-300">7</button>
                        <button onclick="calcApp.num('${id}', '8')" class="bg-white hover:bg-gray-100 text-black font-bold rounded shadow-md active:shadow-inner border border-gray-300">8</button>
                        <button onclick="calcApp.num('${id}', '9')" class="bg-white hover:bg-gray-100 text-black font-bold rounded shadow-md active:shadow-inner border border-gray-300">9</button>
                        <button onclick="calcApp.op('${id}', '*')" class="bg-gray-300 hover:bg-gray-400 text-black font-bold rounded shadow-md active:shadow-inner">×</button>
                        <button onclick="calcApp.num('${id}', '4')" class="bg-white hover:bg-gray-100 text-black font-bold rounded shadow-md active:shadow-inner border border-gray-300">4</button>
                        <button onclick="calcApp.num('${id}', '5')" class="bg-white hover:bg-gray-100 text-black font-bold rounded shadow-md active:shadow-inner border border-gray-300">5</button>
                        <button onclick="calcApp.num('${id}', '6')" class="bg-white hover:bg-gray-100 text-black font-bold rounded shadow-md active:shadow-inner border border-gray-300">6</button>
                        <button onclick="calcApp.op('${id}', '-')" class="bg-gray-300 hover:bg-gray-400 text-black font-bold rounded shadow-md active:shadow-inner">−</button>
                        <button onclick="calcApp.num('${id}', '1')" class="bg-white hover:bg-gray-100 text-black font-bold rounded shadow-md active:shadow-inner border border-gray-300">1</button>
                        <button onclick="calcApp.num('${id}', '2')" class="bg-white hover:bg-gray-100 text-black font-bold rounded shadow-md active:shadow-inner border border-gray-300">2</button>
                        <button onclick="calcApp.num('${id}', '3')" class="bg-white hover:bg-gray-100 text-black font-bold rounded shadow-md active:shadow-inner border border-gray-300">3</button>
                        <button onclick="calcApp.op('${id}', '+')" class="bg-gray-300 hover:bg-gray-400 text-black font-bold rounded shadow-md active:shadow-inner">+</button>
                        <button onclick="calcApp.num('${id}', '0')" class="bg-white hover:bg-gray-100 text-black font-bold rounded shadow-md active:shadow-inner border border-gray-300 col-span-2">0</button>
                        <button onclick="calcApp.num('${id}', '.')" class="bg-white hover:bg-gray-100 text-black font-bold rounded shadow-md active:shadow-inner border border-gray-300">.</button>
                        <button onclick="calcApp.solve('${id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold rounded shadow-md active:shadow-inner">=</button>
                    </div>
                </div>`
            },
            'word': {
                id: 'word', name: 'Word Processor', icon: 'fa-solid fa-file-word', color: 'text-blue-600', width: 35, height: 28,
                content: (id) => `
                <div class="flex flex-col h-full bg-[#2b2b2b]">
                    <div class="h-12 bg-[#2b2b2b] border-b border-white/10 flex items-center gap-2 px-4">
                        <button onclick="document.getElementById('word-text-${id}').style.fontWeight = document.getElementById('word-text-${id}').style.fontWeight === 'bold' ? 'normal' : 'bold'" class="px-3 py-1 bg-white/10 hover:bg-white/20 rounded text-xs font-bold">B</button>
                        <button onclick="document.getElementById('word-text-${id}').style.fontStyle = document.getElementById('word-text-${id}').style.fontStyle === 'italic' ? 'normal' : 'italic'" class="px-3 py-1 bg-white/10 hover:bg-white/20 rounded text-xs italic">I</button>
                        <button onclick="document.getElementById('word-text-${id}').style.textDecoration = document.getElementById('word-text-${id}').style.textDecoration === 'underline' ? 'none' : 'underline'" class="px-3 py-1 bg-white/10 hover:bg-white/20 rounded text-xs underline">U</button>
                        <div class="h-6 w-px bg-white/20"></div>
                        <select onchange="document.getElementById('word-text-${id}').style.fontSize = this.value" class="px-2 py-1 bg-white/10 border border-white/20 rounded text-xs">
                            <option value="12px">12</option>
                            <option value="14px" selected>14</option>
                            <option value="16px">16</option>
                            <option value="18px">18</option>
                            <option value="24px">24</option>
                            <option value="32px">32</option>
                        </select>
                        <input type="color" onchange="document.getElementById('word-text-${id}').style.color = this.value" class="w-8 h-8 cursor-pointer border border-white/20 rounded">
                    </div>
                    <div class="flex-1 overflow-auto p-8 bg-[#1e1e1e]">
                        <div id="word-text-${id}" contenteditable="true" class="bg-white text-black p-8 min-h-full shadow-lg outline-none" style="font-size: 14px;">
                            Start typing your document here...
                        </div>
                    </div>
                </div>`
            },
            'minesweeper': {
                id: 'minesweeper', name: 'Minesweeper', icon: 'fa-solid fa-bomb', color: 'text-red-400', width: 22, height: 28,
                content: (id) => {
                    setTimeout(() => minesweeperGame.init(`ms-grid-${id}`, `ms-count-${id}`, `ms-timer-${id}`), 100);
                    return `
                    <div class="flex flex-col h-full bg-gray-300 p-2 select-none">
                        <div class="bg-gray-200 border-2 border-gray-400 p-2 mb-2 flex justify-between items-center">
                            <div class="bg-black text-red-500 font-mono text-lg px-2 py-1 border-2 border-gray-400" id="ms-count-${id}">015</div>
                            <button onclick="minesweeperGame.reset()" class="text-2xl hover:scale-110 transition">😊</button>
                            <div class="bg-black text-red-500 font-mono text-lg px-2 py-1 border-2 border-gray-400" id="ms-timer-${id}">000</div>
                        </div>
                        <div class="flex-1 bg-gray-200 border-2 border-gray-400 p-2 overflow-auto flex justify-center items-center">
                            <div class="grid grid-cols-10 gap-0" id="ms-grid-${id}"></div>
                        </div>
                        <div class="text-xs text-center mt-2 text-gray-700">Left-click to reveal • Right-click to flag</div>
                    </div>`;
                }
            },
            'tictactoe': {
                id: 'tictactoe', name: 'Tic-Tac-Toe', icon: 'fa-solid fa-hashtag', color: 'text-blue-400', width: 22, height: 28,
                content: (id) => {
                    setTimeout(() => ticTacToeGame.init(`ttt-board-${id}`, `ttt-status-${id}`, `ttt-x-${id}`, `ttt-o-${id}`), 100);
                    return `
                    <div class="flex flex-col h-full bg-gradient-to-br from-blue-100 to-purple-100 p-4 select-none">
                        <div class="text-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">Tic-Tac-Toe</h2>
                            <div class="text-lg font-semibold text-gray-700" id="ttt-status-${id}">Player X's Turn</div>
                        </div>
                        <div class="flex-1 flex items-center justify-center">
                            <div class="grid grid-cols-3 gap-1 bg-gray-800 p-1 rounded-lg shadow-xl" id="ttt-board-${id}"></div>
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                            <div class="text-center">
                                <div class="text-sm text-gray-600">Player X</div>
                                <div class="text-2xl font-bold text-blue-600" id="ttt-x-${id}">0</div>
                            </div>
                            <button onclick="ticTacToeGame.reset()" class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition font-semibold">New Game</button>
                            <div class="text-center">
                                <div class="text-sm text-gray-600">Player O</div>
                                <div class="text-2xl font-bold text-red-600" id="ttt-o-${id}">0</div>
                            </div>
                        </div>
                    </div>`;
                }
            }
        };

        class WindowManager {
            constructor() {
                this.windows = {};
                this.zIndex = 10; // Base Z-Index for windows (Taskbar is 50)
                this.windowArea = document.getElementById('window-area');
                this.taskbarApps = document.getElementById('taskbar-apps');
                this.currentWindowIndex = -1;
                this.setupKeyboardShortcuts();
            }
            
            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Alt+Tab: Switch between windows
                    if (e.altKey && e.key === 'Tab') {
                        e.preventDefault();
                        this.cycleWindows();
                    }
                    
                    // Meta/Win: Toggle Start Menu
                    if (e.key === 'Meta' || e.key === 'OS') {
                        e.preventDefault();
                        sys.toggleStartMenu();
                    }
                    
                    // F11: Toggle fullscreen
                    if (e.key === 'F11') {
                        e.preventDefault();
                        this.toggleFullscreen();
                    }
                    
                    // Ctrl+W: Close active window
                    if (e.ctrlKey && e.key === 'w') {
                        e.preventDefault();
                        const activeWin = this.getActiveWindow();
                        if (activeWin) this.closeWindow(activeWin);
                    }
                    
                    // Escape: Close Start Menu/context menus
                    if (e.key === 'Escape') {
                        const menu = document.getElementById('start-menu');
                        const isOpen = menu.style.bottom === '3rem' || menu.style.bottom === '48px';
                        if (isOpen) {
                            sys.toggleStartMenu();
                        }
                        const ctxMenu = document.getElementById('context-menu');
                        if(ctxMenu && ctxMenu.style.display !== 'none') {
                            ctxMenu.style.display = 'none';
                        }
                    }
                });
            }
            
            cycleWindows() {
                const winIds = Object.keys(this.windows).filter(id => !this.windows[id].minimized);
                if (winIds.length === 0) return;
                
                this.currentWindowIndex = (this.currentWindowIndex + 1) % winIds.length;
                const nextWinId = winIds[this.currentWindowIndex];
                this.bringToFront(nextWinId);
            }
            
            getActiveWindow() {
                let maxZ = -1;
                let activeId = null;
                Object.keys(this.windows).forEach(id => {
                    const z = parseInt(this.windows[id].element.style.zIndex);
                    if (z > maxZ) {
                        maxZ = z;
                        activeId = id;
                    }
                });
                return activeId;
            }
            
            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }
            openWindow(appId, extraData = {}) {
                if (extraData.type === 'folder') {
                    if (this.windows['explorer']) {
                        this.bringToFront('explorer');
                        fileExplorer.nav('explorer', extraData.target);
                        return;
                    }
                    appId = 'explorer';
                }
                
                let winId = appId; 
                
                if (this.windows[winId]) {
                    this.bringToFront(winId);
                    // If settings app, switch tab
                    if(appId === 'settings' && extraData.tab) {
                        settingsApp.switchTab(winId, extraData.tab);
                    }
                    return;
                }

                const config = APPS[appId];
                if (!config) return;

                const el = document.createElement('div');
                el.id = winId;
                el.className = `absolute flex flex-col rounded-lg shadow-2xl border border-white/10 bg-[#202020] overflow-hidden window-transition pointer-events-auto window-fade-in window-active window-shadow-high`;
                el.style.width = `${config.width}rem`;
                el.style.height = `${config.height}rem`;
                el.style.top = `${5 + (Math.random() * 5)}%`;
                el.style.left = `${15 + (Math.random() * 5)}%`;
                el.style.zIndex = ++this.zIndex;

                const title = extraData.name || config.name;
                
                // Check if this is a game or heavy app that needs loading screen
                const needsLoading = ['snake', 'shooter', 'minesweeper', 'tictactoe', 'chrome', 'word', 'paint'].includes(appId);

                el.innerHTML = `
                    <div class="h-9 bg-[#202020] flex justify-between items-center select-none" id="${winId}-header">
                        <div class="flex items-center px-3 gap-3">
                            <i class="${config.icon} ${config.color} text-xs"></i>
                            <span class="text-xs font-medium text-white">${title}</span>
                        </div>
                        <div class="flex h-full">
                            <button class="w-11 h-full hover:bg-white/10 flex items-center justify-center transition text-white" onclick="wm.minimizeWindow('${winId}')"><i class="fa-solid fa-minus text-[10px]"></i></button>
                            <button class="w-11 h-full hover:bg-white/10 flex items-center justify-center transition text-white" onclick="wm.maximizeWindow('${winId}')"><i class="fa-regular fa-square text-[10px]"></i></button>
                            <button class="w-11 h-full hover:bg-red-500 flex items-center justify-center transition group text-white" onclick="wm.closeWindow('${winId}')"><i class="fa-solid fa-xmark text-[12px]"></i></button>
                        </div>
                    </div>
                    <div class="flex-1 relative overflow-hidden bg-[#202020]" id="${winId}-content">
                        ${needsLoading ? `
                        <div class="loading-screen">
                            <div class="loading-spinner"></div>
                            <div class="text-white mt-4 text-sm">Loading ${title}...</div>
                        </div>
                        ` : ''}
                        ${config.content(winId, extraData)}
                    </div>
                    <!-- Resize Handles -->
                    <div class="resize-handle resize-handle-n" data-direction="n"></div>
                    <div class="resize-handle resize-handle-s" data-direction="s"></div>
                    <div class="resize-handle resize-handle-e" data-direction="e"></div>
                    <div class="resize-handle resize-handle-w" data-direction="w"></div>
                    <div class="resize-handle resize-handle-ne" data-direction="ne"></div>
                    <div class="resize-handle resize-handle-nw" data-direction="nw"></div>
                    <div class="resize-handle resize-handle-se" data-direction="se"></div>
                    <div class="resize-handle resize-handle-sw" data-direction="sw"></div>
                `;

                this.windowArea.appendChild(el);
                const header = el.querySelector(`#${winId}-header`);
                if(header) header.addEventListener('mousedown', (e) => this.startDrag(e, el, winId));
                el.addEventListener('mousedown', () => this.bringToFront(winId));

                // Add resize listeners to all handles
                const resizeHandles = el.querySelectorAll('.resize-handle');
                resizeHandles.forEach(handle => {
                    handle.addEventListener('mousedown', (e) => this.startResize(e, el, winId, handle.dataset.direction));
                });

                this.windows[winId] = { id: winId, element: el, minimized: false, maximized: false, prevRect: null };
                this.addTaskbarItem(appId, winId);
                
                // If Chrome/Terminal, ensure initialization
                if(appId === 'chrome') chromeApp.go(winId);
                if(appId === 'terminal') terminalApp.init(winId);
            }

            closeWindow(id) {
                if (!this.windows[id]) return;
                this.windows[id].element.remove();
                delete this.windows[id];
                this.removeTaskbarItem(id);
                
                if(id === 'snake') {
                    clearInterval(snakeGame.interval);
                    if(snakeGame.inputHandler) document.removeEventListener('keydown', snakeGame.inputHandler);
                }
                if(id === 'shooter') {
                    cancelAnimationFrame(shooterGame.animId);
                    if(shooterGame.keyDownHandler) window.removeEventListener('keydown', shooterGame.keyDownHandler);
                    if(shooterGame.keyUpHandler) window.removeEventListener('keyup', shooterGame.keyUpHandler);
                }
            }

            minimizeWindow(id) { 
                const win = this.windows[id];
                win.element.classList.add('minimize-animation');
                setTimeout(() => {
                    win.element.style.display = 'none';
                    win.element.classList.remove('minimize-animation');
                    win.minimized = true;
                }, 300);
            }
            restoreWindow(id) { 
                const win = this.windows[id];
                win.element.style.display = 'flex';
                win.element.classList.add('restore-animation');
                win.minimized = false;
                this.bringToFront(id);
                setTimeout(() => {
                    win.element.classList.remove('restore-animation');
                }, 300);
            }
            maximizeWindow(id) { 
                const win = this.windows[id];
                if(win.maximized) { 
                    Object.assign(win.element.style, win.prevRect); 
                    win.maximized = false; 
                } else { 
                    win.prevRect = { width: win.element.style.width, height: win.element.style.height, top: win.element.style.top, left: win.element.style.left };
                    Object.assign(win.element.style, { width: '100%', height: '100%', top: '0', left: '0' });
                    win.maximized = true;
                }
            }
            bringToFront(id) { 
                if(this.windows[id]) {
                    // Set all windows to inactive
                    Object.keys(this.windows).forEach(winId => {
                        const el = this.windows[winId].element;
                        el.classList.remove('window-active', 'window-shadow-high');
                        el.classList.add('window-inactive', 'window-shadow-low');
                    });
                    
                    // Set this window to active
                    const el = this.windows[id].element;
                    el.style.zIndex = ++this.zIndex;
                    el.classList.remove('window-inactive', 'window-shadow-low');
                    el.classList.add('window-active', 'window-shadow-high');
                }
            }
            startDrag(e, el, id) {
                if(this.windows[id].maximized) return;
                this.bringToFront(id);
                e.preventDefault();
                e.stopPropagation();
                const blocker = el.querySelector('.iframe-blocker');
                if(blocker) blocker.style.pointerEvents = 'auto';
                
                let shiftX = e.clientX - el.getBoundingClientRect().left;
                let shiftY = e.clientY - el.getBoundingClientRect().top;
                const onMove = (ev) => {
                    el.style.left = (ev.pageX - shiftX) + 'px';
                    el.style.top = (ev.pageY - shiftY) + 'px';
                }
                document.addEventListener('mousemove', onMove);
                document.onmouseup = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.onmouseup = null;
                    if(blocker) blocker.style.pointerEvents = 'none';
                };
            }
            startResize(e, el, id, direction) {
                if(this.windows[id].maximized) return;
                this.bringToFront(id);
                e.preventDefault();
                e.stopPropagation();
                
                const blocker = el.querySelector('.iframe-blocker');
                if(blocker) blocker.style.pointerEvents = 'auto';
                
                const rect = el.getBoundingClientRect();
                const startX = e.clientX;
                const startY = e.clientY;
                const startWidth = rect.width;
                const startHeight = rect.height;
                const startLeft = rect.left;
                const startTop = rect.top;
                
                const onMove = (ev) => {
                    const deltaX = ev.clientX - startX;
                    const deltaY = ev.clientY - startY;
                    
                    let newWidth = startWidth;
                    let newHeight = startHeight;
                    let newLeft = startLeft;
                    let newTop = startTop;
                    
                    // Handle different directions
                    if(direction.includes('e')) {
                        newWidth = Math.max(200, startWidth + deltaX);
                    }
                    if(direction.includes('w')) {
                        newWidth = Math.max(200, startWidth - deltaX);
                        newLeft = startLeft + deltaX;
                        if(newWidth === 200) newLeft = startLeft + startWidth - 200;
                    }
                    if(direction.includes('s')) {
                        newHeight = Math.max(150, startHeight + deltaY);
                    }
                    if(direction.includes('n')) {
                        newHeight = Math.max(150, startHeight - deltaY);
                        newTop = startTop + deltaY;
                        if(newHeight === 150) newTop = startTop + startHeight - 150;
                    }
                    
                    el.style.width = newWidth + 'px';
                    el.style.height = newHeight + 'px';
                    el.style.left = newLeft + 'px';
                    el.style.top = newTop + 'px';
                };
                
                document.addEventListener('mousemove', onMove);
                document.onmouseup = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.onmouseup = null;
                    if(blocker) blocker.style.pointerEvents = 'none';
                };
            }
            addTaskbarItem(appId, winId) {
                const config = APPS[appId];
                if(document.getElementById(`tb-${winId}`)) return;
                const btn = document.createElement('button');
                btn.id = `tb-${winId}`;
                btn.className = `w-10 h-10 rounded hover:bg-white/10 flex items-center justify-center transition relative taskbar-item-active`;
                btn.innerHTML = `<i class="${config.icon} ${config.color} text-xl"></i>`;
                btn.onclick = () => this.windows[winId].minimized ? this.restoreWindow(winId) : this.minimizeWindow(winId);
                
                // Preview functionality
                const preview = document.createElement('div');
                preview.className = 'taskbar-preview';
                preview.style.position = 'fixed';
                preview.innerHTML = `
                    <div class="flex items-center justify-between mb-2 px-2">
                        <div class="text-xs text-white">${config.name}</div>
                        <button class="w-6 h-6 bg-red-500 hover:bg-red-600 rounded flex items-center justify-center text-white text-xs transition" id="close-preview-${winId}">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="w-48 h-32 bg-gray-800 rounded overflow-hidden relative border border-white/10 cursor-pointer" id="preview-content-${winId}">
                        <div class="absolute inset-0 flex items-center justify-center text-gray-500 text-xs">Window Preview</div>
                    </div>
                `;
                
                document.body.appendChild(preview);
                
                // Close button functionality
                const closeBtn = document.getElementById(`close-preview-${winId}`);
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    preview.classList.remove('show');
                    this.closeWindow(winId);
                };
                
                // Click preview to restore/focus window
                const previewContent = document.getElementById(`preview-content-${winId}`);
                previewContent.onclick = () => {
                    if (this.windows[winId].minimized) {
                        this.restoreWindow(winId);
                    } else {
                        this.bringToFront(winId);
                    }
                    preview.classList.remove('show');
                };
                
                // Hover management with delay
                let hideTimeout;
                
                btn.onmouseenter = () => {
                    clearTimeout(hideTimeout);
                    const rect = btn.getBoundingClientRect();
                    preview.style.left = `${rect.left + rect.width / 2 - 96}px`;
                    preview.style.bottom = '60px';
                    
                    // Capture window preview
                    const windowEl = this.windows[winId].element;
                    if (windowEl) {
                        const previewContent = document.getElementById(`preview-content-${winId}`);
                        const scale = 0.25;
                        previewContent.innerHTML = `
                            <div style="transform: scale(${scale}); transform-origin: top left; width: ${100/scale}%; height: ${100/scale}%;">
                                ${windowEl.innerHTML}
                            </div>
                        `;
                    }
                    
                    setTimeout(() => preview.classList.add('show'), 100);
                };
                
                btn.onmouseleave = () => {
                    hideTimeout = setTimeout(() => {
                        preview.classList.remove('show');
                    }, 200);
                };
                
                preview.onmouseenter = () => {
                    clearTimeout(hideTimeout);
                    preview.classList.add('show');
                };
                
                preview.onmouseleave = () => {
                    preview.classList.remove('show');
                };
                
                this.taskbarApps.appendChild(btn);
            }
            removeTaskbarItem(id) { 
                const el = document.getElementById(`tb-${id}`); 
                if(el) el.remove();
                // Also remove preview element
                const preview = document.querySelector(`.taskbar-preview`);
                if(preview && preview.innerHTML.includes(id)) preview.remove();
            }
            zoom(id, val) { /* ... */ }
        }

        // --- Settings App Logic ---
        const settingsApp = {
            render: function(winId, tab) {
                return `
                    <div class="flex h-full bg-[#f3f3f3] text-black">
                        <!-- Sidebar -->
                        <div class="w-64 bg-[#f0f0f0] p-4 border-r border-gray-300 flex flex-col gap-1">
                            <div class="font-bold text-lg mb-4 px-2">Settings</div>
                            
                            <div class="flex items-center gap-3 p-2 rounded ${tab === 'system' ? 'bg-white shadow-sm' : 'hover:bg-white/50'} cursor-pointer transition" onclick="settingsApp.switchTab('${winId}', 'system')">
                                <i class="fa-solid fa-desktop text-blue-500 w-5 text-center"></i> 
                                <span class="text-sm">System</span>
                            </div>
                            
                            <div class="flex items-center gap-3 p-2 rounded ${tab === 'personalization' ? 'bg-white shadow-sm' : 'hover:bg-white/50'} cursor-pointer transition" onclick="settingsApp.switchTab('${winId}', 'personalization')">
                                <i class="fa-solid fa-paintbrush text-pink-500 w-5 text-center"></i> 
                                <span class="text-sm">Personalization</span>
                            </div>
                            
                            <div class="flex items-center gap-3 p-2 rounded ${tab === 'theme' ? 'bg-white shadow-sm' : 'hover:bg-white/50'} cursor-pointer transition" onclick="settingsApp.switchTab('${winId}', 'theme')">
                                <i class="fa-solid fa-palette text-purple-500 w-5 text-center"></i> 
                                <span class="text-sm">Theme</span>
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="flex-1 p-8 bg-[#f9f9f9] overflow-y-auto" id="settings-content-${winId}">
                            ${this.getTabContent(tab)}
                        </div>
                    </div>
                `;
            },
            getTabContent: function(tab) {
                if (tab === 'system') {
                    return `
                        <h2 class="text-2xl font-semibold mb-6">System > Display</h2>
                        
                        <div class="bg-white p-4 rounded-lg border border-gray-200 mb-4 shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <div class="font-medium">Scale</div>
                                    <div class="text-xs text-gray-500">Change the size of text, apps, and other items</div>
                                </div>
                                <select class="bg-[#f3f3f3] border border-gray-300 rounded px-3 py-1 text-sm outline-none" onchange="sys.setScale(this.value)">
                                    <option value="100">100% (Recommended)</option>
                                    <option value="125">125%</option>
                                    <option value="150">150%</option>
                                </select>
                            </div>
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-medium">Display resolution</div>
                                    <div class="text-xs text-gray-500">Adjust the resolution to fit your screen</div>
                                </div>
                                <select class="bg-[#f3f3f3] border border-gray-300 rounded px-3 py-1 text-sm outline-none" onchange="sys.setResolution(this.value)">
                                    <option value="full">Full Screen (Recommended)</option>
                                    <option value="1920x1080">1920 x 1080</option>
                                    <option value="1280x720">1280 x 720</option>
                                    <option value="1024x768">1024 x 768</option>
                                </select>
                            </div>
                        </div>
                         <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <div class="font-medium mb-2">Brightness</div>
                            <input type="range" min="0" max="100" value="100" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="sys.setBrightness(this.value)">
                        </div>
                    `;
                } else if (tab === 'personalization') {
                    const wallpapers = [
                        'https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop', // Default Space
                        'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?q=80&w=2070&auto=format&fit=crop', // Nature
                        'https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=2070&auto=format&fit=crop', // Abstract
                        'https://images.unsplash.com/photo-1483729558449-99ef09a8c325?q=80&w=2070&auto=format&fit=crop', // Dark
                        'https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=2070&auto=format&fit=crop', // Landscape
                        'https://images.unsplash.com/photo-1558591710-4b4a1ae0f04d?q=80&w=1000&auto=format&fit=crop' // Pattern
                    ];
                    
                    return `
                        <h2 class="text-2xl font-semibold mb-6">Personalization > Background</h2>
                        
                        <!-- Wallpaper Type -->
                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm mb-4">
                            <div class="font-medium mb-4">Background Type</div>
                            <div class="flex gap-4">
                                <button onclick="sys.setWallpaperType('static')" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                    🖼️ Static Image
                                </button>
                                <button onclick="sys.setWallpaperType('animated')" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition">
                                    ✨ Animated Gradient
                                </button>
                                <button onclick="sys.setWallpaperType('particles')" class="px-4 py-2 bg-pink-500 text-white rounded hover:bg-pink-600 transition">
                                    🌟 Particle System
                                </button>
                            </div>
                        </div>
                        
                        <!-- Static Wallpapers -->
                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm mb-4">
                             <div class="font-medium mb-4">Static Wallpapers</div>
                             <div class="grid grid-cols-3 gap-4">
                                ${wallpapers.map(url => `
                                    <div class="aspect-video rounded-md overflow-hidden border-2 border-transparent hover:border-blue-500 cursor-pointer transition" onclick="sys.changeWallpaper('${url}')">
                                        <img src="${url}" class="w-full h-full object-cover">
                                    </div>
                                `).join('')}
                             </div>
                        </div>
                        
                        <!-- Animated Gradients -->
                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                            <div class="font-medium mb-4">Animated Gradients</div>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="aspect-video rounded-md overflow-hidden border-2 border-transparent hover:border-blue-500 cursor-pointer transition" onclick="sys.setAnimatedGradient('default')">
                                    <div class="w-full h-full animated-gradient"></div>
                                </div>
                                <div class="aspect-video rounded-md overflow-hidden border-2 border-transparent hover:border-blue-500 cursor-pointer transition" onclick="sys.setAnimatedGradient('blue')">
                                    <div class="w-full h-full animated-gradient-blue"></div>
                                </div>
                                <div class="aspect-video rounded-md overflow-hidden border-2 border-transparent hover:border-blue-500 cursor-pointer transition" onclick="sys.setAnimatedGradient('purple')">
                                    <div class="w-full h-full animated-gradient-purple"></div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (tab === 'theme') {
                    const themes = [
                        { id: 'dark', name: 'Dark', preview: '#111', icon: '🌙' },
                        { id: 'light', name: 'Light', preview: '#f0f0f0', icon: '☀️' },
                        { id: 'blue', name: 'Ocean Blue', preview: '#0a0e27', icon: '🌊' },
                        { id: 'purple', name: 'Royal Purple', preview: '#1a0d2e', icon: '👑' },
                        { id: 'green', name: 'Forest Green', preview: '#0a2e0a', icon: '🌲' }
                    ];
                    
                    return `
                        <h2 class="text-2xl font-semibold mb-6">Theme > Color Scheme</h2>
                        
                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                            <div class="font-medium mb-4">Choose your theme</div>
                            <div class="grid grid-cols-2 gap-4">
                                ${themes.map(theme => `
                                    <div class="border-2 border-gray-200 hover:border-blue-500 rounded-lg p-4 cursor-pointer transition" onclick="sys.changeTheme('${theme.id}')">
                                        <div class="flex items-center gap-3 mb-2">
                                            <div class="text-2xl">${theme.icon}</div>
                                            <div class="font-semibold">${theme.name}</div>
                                        </div>
                                        <div class="w-full h-16 rounded" style="background: ${theme.preview}"></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            },
            switchTab: function(winId, tab) {
                const container = document.getElementById(`settings-content-${winId}`);
                if (container) {
                    container.innerHTML = this.getTabContent(tab);
                    // Also update sidebar active state
                    const win = document.getElementById(winId);
                    const sidebarItems = win.querySelectorAll('.w-64 .flex');
                    sidebarItems.forEach(item => {
                        if(item.innerText.toLowerCase().includes(tab)) {
                            item.className = "flex items-center gap-3 p-2 rounded bg-white shadow-sm cursor-pointer transition";
                        } else {
                            item.className = "flex items-center gap-3 p-2 rounded hover:bg-white/50 cursor-pointer transition";
                        }
                    });
                }
            }
        };

        // --- Sys Logic ---
        const sys = {
            sortOrder: { by: 'name', asc: true },
            
            // LocalStorage Management
            saveState: function() {
                const state = {
                    wallpaper: document.getElementById('ui-root').style.backgroundImage,
                    brightness: parseInt(document.getElementById('brightness-overlay').style.opacity * 100 / 0.8) || 100,
                    scale: parseFloat(document.documentElement.style.fontSize) / 16 * 100 || 100,
                    resolution: this.getCurrentResolution(),
                    snakeHighScore: snakeGame.highScore,
                    shooterHighScore: shooterGame.highScore,
                    windows: Object.keys(wm.windows).map(id => ({
                        id: wm.windows[id].id,
                        left: wm.windows[id].element.style.left,
                        top: wm.windows[id].element.style.top,
                        width: wm.windows[id].element.style.width,
                        height: wm.windows[id].element.style.height,
                        minimized: wm.windows[id].minimized
                    }))
                };
                localStorage.setItem('niazOS_state', JSON.stringify(state));
            },
            
            loadState: function() {
                const saved = localStorage.getItem('niazOS_state');
                if (!saved) return;
                
                try {
                    const state = JSON.parse(saved);
                    
                    // Restore wallpaper
                    if (state.wallpaper) {
                        document.getElementById('ui-root').style.backgroundImage = state.wallpaper;
                    }
                    
                    // Restore brightness
                    if (state.brightness) {
                        this.setBrightness(state.brightness);
                    }
                    
                    // Restore scale
                    if (state.scale) {
                        this.setScale(state.scale);
                    }
                    
                    // Restore resolution
                    if (state.resolution) {
                        this.setResolution(state.resolution);
                    }
                    
                    // Restore high scores
                    if (state.snakeHighScore) snakeGame.highScore = state.snakeHighScore;
                    if (state.shooterHighScore) shooterGame.highScore = state.shooterHighScore;
                    
                } catch(e) {
                    console.error('Failed to load state:', e);
                }
                
                // Restore theme separately
                const savedTheme = localStorage.getItem('niazOS_theme');
                if (savedTheme && savedTheme !== 'dark') {
                    document.documentElement.setAttribute('data-theme', savedTheme);
                }
            },
            
            getCurrentResolution: function() {
                const root = document.getElementById('ui-root');
                if (root.style.width === '100%' || root.style.width === '') return 'full';
                return root.style.width.replace('px', '') + 'x' + root.style.height.replace('px', '');
            },
            
            toggleStartMenu: () => {
                const menu = document.getElementById('start-menu');
                // Check if menu is currently open by checking if bottom is 3rem (48px taskbar height)
                const isOpen = menu.style.bottom === '3rem' || menu.style.bottom === '48px';
                
                if (isOpen) {
                    menu.style.bottom = '-40.625rem';
                    menu.style.opacity = '0';
                } else {
                    menu.style.bottom = '3rem';
                    menu.style.opacity = '1';
                }
            },
            renderDesktop: () => {
                const container = document.getElementById('desktop-icons');
                container.innerHTML = '';
                FILE_SYSTEM['desktop'].forEach(icon => {
                    const el = document.createElement('div');
                    el.className = 'w-20 h-24 flex flex-col items-center justify-center hover:bg-white/10 rounded border border-transparent hover:border-white/10 cursor-default transition group';
                    let iconHtml = icon.icon.startsWith('http') 
                        ? `<img src="${icon.icon}" class="w-10 h-10 rounded-full mb-2 shadow-md bg-gray-800">` 
                        : `<i class="${icon.icon} ${icon.color} text-3xl mb-2 drop-shadow-md"></i>`;
                    el.innerHTML = `${iconHtml}<span class="text-xs text-center text-white drop-shadow shadow-black line-clamp-2">${icon.name}</span>`;
                    el.ondblclick = () => wm.openWindow(icon.appId, icon);
                    container.appendChild(el);
                });
            },
            renderStartMenu: () => {
                const grid = document.getElementById('start-menu-grid');
                if (!grid) return;
                
                grid.innerHTML = '';
                
                // Define pinned apps from APPS config
                const pinnedApps = [
                    'explorer', 'terminal', 'chrome', 'notepad', 
                    'pdf-viewer', 'paint', 'calculator', 'word',
                    'snake', 'shooter', 'minesweeper', 'tictactoe', 'settings'
                ];
                
                pinnedApps.forEach(appId => {
                    const app = APPS[appId];
                    if (!app) return;
                    
                    const el = document.createElement('div');
                    el.className = 'flex flex-col items-center gap-2 p-3 hover:bg-white/10 rounded-lg cursor-pointer transition';
                    el.innerHTML = `
                        <i class="${app.icon} ${app.color} text-2xl"></i>
                        <span class="text-xs text-center leading-tight">${app.name}</span>
                    `;
                    el.onclick = () => {
                        // For pdf-viewer, pass the resume file data
                        if (appId === 'pdf-viewer') {
                            const resumeFile = FILE_SYSTEM['niaz_profile'][0]; // Resume.pdf
                            wm.openWindow(appId, resumeFile);
                        } else {
                            wm.openWindow(appId);
                        }
                        sys.toggleStartMenu();
                    };
                    grid.appendChild(el);
                });
            },
            initClock: () => {
                setInterval(() => {
                    const now = new Date();
                    document.getElementById('clock-time').innerText = now.toLocaleTimeString([],{hour:'numeric',minute:'2-digit'});
                    document.getElementById('clock-date').innerText = now.toLocaleDateString();
                }, 1000);
            },
            sortDesktop: () => {} // Logic preserved from previous
            ,changeWallpaper: (url) => {
                const root = document.getElementById('ui-root');
                root.style.backgroundImage = `url('${url}')`;
                
                // Disable animated backgrounds
                const animBg = document.getElementById('animated-bg');
                const particleCanvas = document.getElementById('particle-canvas');
                if (animBg) {
                    animBg.className = '';
                    animBg.classList.remove('active');
                }
                if (particleCanvas) particleCanvas.style.opacity = '0';
                if (window.particleSystem) window.particleSystem.stop();
                
                sys.saveState();
            },
            setWallpaperType: (type) => {
                if (type === 'static') {
                    sys.changeWallpaper('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop');
                } else if (type === 'animated') {
                    sys.setAnimatedGradient('default');
                } else if (type === 'particles') {
                    sys.startParticles();
                }
            },
            setAnimatedGradient: (variant) => {
                const root = document.getElementById('ui-root');
                root.style.backgroundImage = 'none';
                
                const animBg = document.getElementById('animated-bg');
                const particleCanvas = document.getElementById('particle-canvas');
                
                if (animBg) {
                    animBg.className = 'active';
                    if (variant === 'blue') {
                        animBg.classList.add('animated-gradient-blue');
                    } else if (variant === 'purple') {
                        animBg.classList.add('animated-gradient-purple');
                    } else {
                        animBg.classList.add('animated-gradient');
                    }
                }
                
                if (particleCanvas) particleCanvas.style.opacity = '0';
                if (window.particleSystem) window.particleSystem.stop();
            },
            startParticles: () => {
                const root = document.getElementById('ui-root');
                root.style.backgroundImage = 'none';
                
                const animBg = document.getElementById('animated-bg');
                const particleCanvas = document.getElementById('particle-canvas');
                
                if (animBg) {
                    animBg.className = '';
                    animBg.classList.remove('active');
                }
                
                if (particleCanvas) {
                    particleCanvas.style.opacity = '1';
                    if (!window.particleSystem) {
                        window.particleSystem = new ParticleSystem(particleCanvas);
                    }
                    window.particleSystem.start();
                }
            },
            changeTheme: (themeId) => {
                if (themeId === 'dark') {
                    document.documentElement.removeAttribute('data-theme');
                } else {
                    document.documentElement.setAttribute('data-theme', themeId);
                }
                localStorage.setItem('niazOS_theme', themeId);
            },
            setScale: (val) => {
                const baseSize = 16;
                const newSize = baseSize * (parseInt(val) / 100);
                document.documentElement.style.fontSize = `${newSize}px`;
                sys.saveState();
            },
            setResolution: (val) => {
                const root = document.getElementById('ui-root');
                if (val === 'full') {
                    root.style.width = '100%';
                    root.style.height = '100%';
                    root.style.border = 'none';
                    root.style.transform = 'none';
                    root.style.top = '0';
                    root.style.borderRadius = '0';
                } else {
                    const [w, h] = val.split('x');
                    root.style.width = `${w}px`;
                    root.style.height = `${h}px`;
                    root.style.border = '1px solid #333';
                    root.style.borderRadius = '4px';
                    root.style.position = 'relative';
                    root.style.top = '50%';
                    root.style.transform = 'translateY(-50%)';
                    root.style.margin = '0 auto';
                }
                sys.saveState();
            },
            setBrightness: (val) => {
                const overlay = document.getElementById('brightness-overlay');
                const brightness = parseInt(val);
                const opacity = (100 - brightness) / 100 * 0.8; 
                overlay.style.opacity = opacity;
                sys.saveState();
            }
        };

        const contextMenu = { init: () => { /* ... logic preserved ... */ }};

        // --- Initialization ---
        const wm = new WindowManager();
        
        // Load saved state first
        sys.loadState();
        
        sys.initClock();
        sys.renderDesktop();
        sys.renderStartMenu();
        
        // Auto-save state every 30 seconds
        setInterval(() => sys.saveState(), 30000);
        
        // Attach context menu listeners
        const desktop = document.getElementById('ui-root');
        const menu = document.getElementById('context-menu');
        desktop.addEventListener('contextmenu', e => {
            e.preventDefault();
            if(e.target.closest('.window-transition') || e.target.closest('#taskbar') || e.target.closest('#start-menu')) return;
            menu.style.left = `${e.clientX}px`;
            menu.style.top = `${e.clientY}px`;
            menu.style.display = 'flex';
            menu.classList.remove('hidden');
        });
        
        // Updated click listener to fix "Start Menu stopped opening" bug
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('start-menu');
            const startBtn = document.getElementById('start-btn'); // Specific ID targeting
            
            // Close logic: If menu is open AND click is outside menu AND click is outside start button
            const isOpen = menu.style.bottom === '3rem' || menu.style.bottom === '48px';
            if (isOpen) {
                if (!menu.contains(e.target) && !startBtn.contains(e.target)) {
                    sys.toggleStartMenu();
                }
            }
            
            // Always hide context menu on click
            const ctxMenu = document.getElementById('context-menu');
            if(ctxMenu) ctxMenu.style.display = 'none'; 
        });

    </script>
</body>
</html>